<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://metrics.couchbase.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
<!-- End Google Tag Manager -->
<title>WITH RECURSIVE Clause | Couchbase Docs</title>
<link rel="canonical" href="https://docs.couchbase.com/server/current/n1ql/n1ql-language-reference/with-recursive.html">
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Use the WITH RECURSIVE clause to enable recursive referencing in common table expressions.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="7.6">
<meta name="page-url" content="/server/current/n1ql/n1ql-language-reference/with-recursive.html">
<meta name="page-nav-header-levels" content="0">

<meta name="docsearch:component" content="server">
<meta name="docsearch:component_title" content="server">
<meta name="docsearch:cversion" content="7.6">
<meta name="docsearch:component_version" content="server@7.6">
<meta name="docsearch:module" content="n1ql">
<meta name="docsearch:breadcrumbs" content="server">
<meta name="docsearch:topic_type" content="reference">
<meta name="docsearch:version_rank" content="1">
<meta name="docsearch:status" content="Couchbase Server 7.6">
<meta name="docsearch:edition" content="">
<meta name="docsearch:page_rank" content="50">


<meta name="generator" content="Antora 3.1.7">
<link rel="icon" href="../../../../_/img/favicon.svg" type="image/svg+xml">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon" sizes="any">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation"
                      href="https://docs.couchbase.com/home/index.html">
                    <img src="../../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">

                  <li class="nav-item "">
                    <a href="https://docs.couchbase.com/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item nav-item-selected">
                    <a class="nav-link" href="../../../../home/server.html">
                      Server
                      
                    </a>
                  </li>
                  <li class="nav-item ">
                    <a class="nav-link" href="../../../../home/mobile.html">
                      Mobile
                      
                    </a>
                  </li>
                  <li class="nav-item ">
                    <a class="nav-link" href="../../../../cloud/index.html">
                      Capella
                      
                    </a>
                  </li>
                  <li class="nav-item ">
                    <a class="nav-link" href="../../../../home/sdk.html">
                      SDKs
                      
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>
              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
    <template id="page-versions" style="display: none">
      <select class="version_list" data-component="server">
        <option value="7.6" data-url="with-recursive.html" selected>7.6</option>
        <option value="7.2" data-url="../../../7.2/introduction/intro.html">7.2</option>
        <option value="7.1" data-url="../../../7.1/index.html">7.1</option>
        <option value="7.0" data-url="../../../7.0/index.html">7.0</option>
      </select>
    </template>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/rayoffiah/projects/couchbase/docs-devex/modules/n1ql/pages/n1ql-language-reference/with-recursive.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../index.html">server</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">WITH RECURSIVE Clause</h1>
<div class="labels">
<ul><li class="reference"><span><i class="fas fa-book"></i></i> reference</span></li>
</ul>
</div>
<div class="labels">
<ul>
<li class="status"><span>Couchbase Server 7.6</span></li>
</ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
Use the WITH RECURSIVE clause to enable recursive referencing in common table expressions.
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="purpose"><a class="anchor" href="#purpose"></a>Purpose</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The common table expressions (CTEs) created by the WITH clause simplify complex queries and create temporary result sets which can be used as data sources or as expressions for queries.</p>
</div>
<div class="paragraph">
<p>The WITH RECURSIVE clause is an extension of the WITH clause which enables you to create recursive queries.
You can use recursive queries with hierarchical data, or data in a tree structure.
In these cases, the data may have an arbitrary number of levels, and you won&#8217;t know in advance how deeply you need to traverse the data.</p>
</div>
<div class="paragraph">
<p>The CTE for a recursive query includes a UNION or UNION ALL <a href="union.html" class="xref page">set operator</a>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The left arm of UNION/UNION ALL contains an anchor clause, which is non-recursive.
The anchor clause produces an initial set of documents as an intermediate result set for the CTE keyspace.</p>
</li>
<li>
<p>The right arm of UNION/UNION ALL contains the recursive clause.
The recursive clause produces a new set of documents.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The recursive clause is executed again, with the CTE keyspace now referring to the result produced by the initial recursive clause.
This process repeats until it results in an empty intermediate result set.
The intermediate result sets are appended to produce a final output.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="syntax"><a class="anchor" href="#syntax"></a>Syntax</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/rayoffiah/projects/couchbase/docs-devex/modules/n1ql/partials/grammar/dql.ebnf#L51-L52">with-recursive-clause ::= 'WITH' 'RECURSIVE' alias 'AS' '(' ( recursive-select | select | expr ) ')' cycle-clause? options-clause?
                                       ( ',' alias 'AS' '(' ( recursive-select | select | expr ) ')' cycle-clause? options-clause? )*</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/with-recursive-clause.png" alt="Syntax diagram">
</div>
</div>
<div class="sect2">
<h3 id="recursive-select"><a class="anchor" href="#recursive-select"></a>Recursive SELECT</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/rayoffiah/projects/couchbase/docs-devex/modules/n1ql/partials/grammar/dql.ebnf#L56">recursive-select ::= anchor-select ('UNION' | 'UNION ALL') recursive-select-term</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/recursive-select.png" alt="Syntax diagram">
</div>
</div>
<div class="paragraph">
<p>The definition for a recursive CTE must be a SELECT statement that includes a UNION or UNION ALL set operator.
If it isn&#8217;t, the CTE is treated as a non-recursive CTE.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">anchor-select</dt>
<dd>
<p>A <a href="select-syntax.html" class="xref page">SELECT query</a> that represents the anchor clause of the CTE.</p>
</dd>
<dt class="hdlist1">recursive-select-term</dt>
<dd>
<p>A <a href="select-syntax.html#select-term" class="xref page">select term</a> that represents the recursive clause of the CTE.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="cycle-clause"><a class="anchor" href="#cycle-clause"></a>CYCLE Clause</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/rayoffiah/projects/couchbase/docs-devex/modules/n1ql/partials/grammar/dql.ebnf#L60">cycle-clause ::= 'CYCLE' expr ( ',' expr )* 'RESTRICT'</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/cycle-clause.png" alt="Syntax diagram">
</div>
</div>
<div class="paragraph">
<p>The optional CYCLE clause provides one method for avoiding infinite recursions.
It enables you to specify one or more fields whose values are likely to repeat.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">expr</dt>
<dd>
<p>(Required) An <a href="identifiers.html" class="xref page">identifier</a> or a <a href="select-syntax.html#path" class="xref page">path</a> representing a field/nested-field.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="options-clause"><a class="anchor" href="#options-clause"></a>OPTIONS Clause</h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-ebnf hljs" data-lang="ebnf" data-source-url="file:///Users/rayoffiah/projects/couchbase/docs-devex/modules/n1ql/partials/grammar/dql.ebnf#L64">options-clause ::= 'OPTIONS' expr</code></pre>
</div>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/n1ql-language-reference/options-clause.png" alt="Syntax diagram">
</div>
</div>
<div class="paragraph">
<p>The optional OPTIONS clause provides another method for avoiding infinite recursions.
It enables you to specify that the recursion should exit after a specified level, or after accumulating a specified number of documents.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">expr</dt>
<dd>
<p>(Required) An object with the following properties.</p>
</dd>
</dl>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col>
<col>
<col>
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Schema</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>levels</strong><br>
<em>optional</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Recursion should exit after reaching this level.
This assumes the anchor is at level 0.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Integer</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>documents</strong><br>
<em>optional</em></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Recursion should exit after accumulating this many documents.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Integer</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="limitations"><a class="anchor" href="#limitations"></a>Limitations</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The recursive reference is only allowed once in the FROM clause.
It&#8217;s not allowed anywhere else.</p>
</li>
<li>
<p>ORDER BY, LIMIT, and OFFSET clauses are not allowed in the SELECT statement in the subquery used to define the anchor and the recursive clause.</p>
</li>
<li>
<p>The DISTINCT quantifier is not allowed in anchor and recursive clauses.</p>
</li>
<li>
<p>GROUP BY, WINDOW, and AGGREGATE functions are not allowed in recursive clauses.</p>
</li>
<li>
<p>OUTER JOINS are not allowed in recursive clauses because they can lead to potential infinite recursion.</p>
</li>
<li>
<p>Recursive clauses do not support NEST and UNNEST clauses.</p>
</li>
<li>
<p>If there is no UNION/UNION ALL separation for the recursive CTE, the query defaults to a normal CTE.</p>
</li>
<li>
<p>A syntax error is returned when optional subclauses are used without the RECURSIVE keyword.</p>
</li>
<li>
<p>In general, recursion is also limited by:</p>
<div class="ulist">
<ul>
<li>
<p>The logic in the recursive statement.</p>
</li>
<li>
<p>The stop in the options argument.</p>
</li>
<li>
<p>Breaching the request timeout, if configured.</p>
</li>
<li>
<p>Breaching the request memory quota, if configured.</p>
</li>
<li>
<p>Exceeding the implicit document limit (10000) when a memory quota is not in use and when no explicit document limit is set in the options.</p>
</li>
<li>
<p>Exceeding the implicit level limit (1000) when the level option is not in use and when no explicit document limit is set in the options.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="examples_section"><a class="anchor" href="#examples_section"></a>Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following examples follow linear recursion.
Only one recursive reference is allowed in the FROM clause.
Self-joins or set-ops are not allowed in the recursive reference.</p>
</div>
<div class="exampleblock">
<div class="title">Example 1. Simple recursive referencing</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">WITH RECURSIVE cte AS (
    SELECT 1 AS r
        UNION
    SELECT cte.r+1 AS r
    FROM cte
    WHERE cte.r&lt;4
)
SELECT cte.r FROM cte;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "r": 1
  },
  {
    "r": 2
  },
  {
    "r": 3
  },
  {
    "r": 4
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 2. Combine recursive and non-recursive CTEs with the WITH clause</div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">WITH RECURSIVE cte AS (SELECT 1 r) ,
    rcte AS (
        SELECT cte.r FROM cte
            UNION
        SELECT rcte.r+2 r FROM rcte WHERE rcte.r&lt;7
    )
SELECT * FROM rcte;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "rcte": {
      "r": 1
    }
  },
  {
    "rcte": {
      "r": 3
    }
  },
  {
    "rcte": {
      "r": 5
    }
  },
  {
    "rcte": {
      "r": 7
    }
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 3. Handle hierarchical or tree-structured data</div>
<div class="content">
<div class="paragraph">
<p>For this example, set the query context to the <code>tenant_agent_00</code> scope in the travel sample dataset.
For more information, see <a href="../n1ql-intro/queriesandresults.html#query-context" class="xref page">Query Context</a>.</p>
</div>
<div class="listingblock">
<div class="title">Create a dataset containing employee information</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE COLLECTION employees IF NOT EXISTS;

INSERT INTO employees
   VALUES ("e1", {
       "employee_id": 1,
       "employee_name": "Carlos"
       }),
   VALUES ("e2", {
       "employee_id": 2,
       "employee_name": "Maya",
       "manager_id": 1
       }),
   VALUES ("e3", {
       "employee_id": 3,
       "employee_name": "Fatima",
       "manager_id": 1
       }),
   VALUES ("e4", {
       "employee_id": 4,
       "employee_name": "Yijing",
       "manager_id": 2
       }),
   VALUES ("e5", {
       "employee_id": 5,
       "employee_name": "Rahul",
       "manager_id": 3
       }),
   VALUES ("e6", {
       "employee_id": 6,
       "employee_name": "Lisa",
       "manager_id": 2
       })
RETURNING *;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Create an index for the employees</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE INDEX e_idx ON employees(manager_id INCLUDE MISSING, employee_id, employee_name);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Find the level of each employee in the organization</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">WITH RECURSIVE emplLevel AS (
   SELECT e.employee_id, e.employee_name, 0 lvl
   FROM employees e
   WHERE manager_id IS MISSING
       UNION
   SELECT e1.employee_id, e1.employee_name, e1.manager_id, emplLevel.lvl+1
   lvl
   FROM employees e1 JOIN emplLevel
   ON e1.manager_id = emplLevel.employee_id
)
SELECT * FROM emplLevel;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "emplLevel": {
      "employee_id": 1,
      "employee_name": "Carlos",
      "lvl": 0
    }
  },
  {
    "emplLevel": {
      "employee_id": 2,
      "employee_name": "Maya",
      "lvl": 1,
      "manager_id": 1
    }
  },
  {
    "emplLevel": {
      "employee_id": 3,
      "employee_name": "Fatima",
      "lvl": 1,
      "manager_id": 1
    }
  },
  {
    "emplLevel": {
      "employee_id": 4,
      "employee_name": "Yijing",
      "lvl": 2,
      "manager_id": 2
    }
  },
  {
    "emplLevel": {
      "employee_id": 6,
      "employee_name": "Lisa",
      "lvl": 2,
      "manager_id": 2
    }
  },
  {
    "emplLevel": {
      "employee_id": 5,
      "employee_name": "Rahul",
      "lvl": 2,
      "manager_id": 3
    }
  }
]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Find the reporting hierarchy of the employees in the organization</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">SELECT e.employee_id, e.employee_name, e.manager_id,
(
    WITH RECURSIVE cte AS (
        SELECT e1.employee_id, e1.employee_name, e1.manager_id
        FROM employees e1 WHERE e1.manager_id = e.employee_id
            UNION
        SELECT e2.employee_id, e2.employee_name, e2.manager_id
        FROM employees e2, cte
        WHERE e2.manager_id = cte.employee_id
    )
    SELECT cte.* FROM cte
) as reports
FROM employees e;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "employee_id": 1,
    "employee_name": "Carlos",
    "reports": [
      {
        "employee_id": 2,
        "employee_name": "Maya",
        "manager_id": 1
      },
      {
        "employee_id": 3,
        "employee_name": "Fatima",
        "manager_id": 1
      },
      {
        "employee_id": 4,
        "employee_name": "Yijing",
        "manager_id": 2
      },
      {
        "employee_id": 6,
        "employee_name": "Lisa",
        "manager_id": 2
      },
      {
        "employee_id": 5,
        "employee_name": "Rahul",
        "manager_id": 3
      }
    ]
  },
  {
    "employee_id": 2,
    "employee_name": "Maya",
    "manager_id": 1,
    "reports": [
      {
        "employee_id": 4,
        "employee_name": "Yijing",
        "manager_id": 2
      },
      {
        "employee_id": 6,
        "employee_name": "Lisa",
        "manager_id": 2
      }
    ]
  },
  {
    "employee_id": 3,
    "employee_name": "Fatima",
    "manager_id": 1,
    "reports": [
      {
        "employee_id": 5,
        "employee_name": "Rahul",
        "manager_id": 3
      }
    ]
  },
  {
    "employee_id": 4,
    "employee_name": "Yijing",
    "manager_id": 2,
    "reports": []
  },
  {
    "employee_id": 6,
    "employee_name": "Lisa",
    "manager_id": 2,
    "reports": []
  },
  {
    "employee_id": 5,
    "employee_name": "Rahul",
    "manager_id": 3,
    "reports": []
  }
]</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="title">Example 4. Use the OPTIONS clause and the CYCLE clause to avoid infinite recursion</div>
<div class="content">
<div class="paragraph">
<p>For this example, set the query context to the <code>tenant_agent_00</code> scope in the travel sample dataset.
For more information, see <a href="../n1ql-intro/queriesandresults.html#query-context" class="xref page">Query Context</a>.</p>
</div>
<div class="listingblock">
<div class="title">Create a dataset containing product information</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE COLLECTION products IF NOT EXISTS;

INSERT INTO products
  VALUES (uuid(), {
    "id": 1,
    "name": "Bicycle",
    "price": 299.99,
    "description": "A sturdy and reliable bicycle.",
    "category": "Sports",
    "related_items": [2, 4]
  }),
  VALUES (uuid(), {
    "id": 2,
    "name": "Helmet",
    "price": 49.99,
    "description": "A safety helmet for cycling.",
    "category": "Sports",
    "related_items": [1, 3]
  }),
  VALUES (uuid(), {
    "id": 3,
    "name": "Water Bottle",
    "price": 9.99,
    "description": "A convenient water bottle for cycling.",
    "category": "Accessories",
    "related_items": [2, 4]
  }),
  VALUES (uuid(), {
    "id": 4,
    "name": "Gloves",
    "price": 19.99,
    "description": "Comfortable gloves for cycling.",
    "category": "Sports",
    "related_items": [1, 3]
  })
RETURNING *;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Create an index for the products</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">CREATE PRIMARY INDEX ON `default`:`travel-sample`.`tenant_agent_00`.`products`</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Query resulting in infinite recursion</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">WITH RECURSIVE similar_items AS (
  SELECT p.*, 0 as lvl FROM products p WHERE p.id=1
    UNION
  SELECT p1.*, similar_items.lvl+1 as lvl FROM products p1,
    similar_items WHERE p1.id IN similar_items.related_items
)
SELECT * FROM similar_items;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "code": 5500,
    "msg": "Request has exceeded memory quota"
  }
]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Solution using the OPTIONS clause to add a level limit</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">WITH RECURSIVE similar_items AS (
  SELECT p.*, 0 as lvl FROM products p WHERE p.id=1
    UNION
  SELECT p1.*, similar_items.lvl+1 as lvl FROM products p1,
    similar_items WHERE p1.id IN similar_items.related_items
)
OPTIONS {"levels":2}
SELECT * FROM similar_items;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "similar_items": {
      "category": "Sports",
      "description": "A sturdy and reliable bicycle.",
      "id": 1,
      "lvl": 0,
      "name": "Bicycle",
      "price": 299.99,
      "related_items": [
        2,
        4
      ]
    }
  },
  {
    "similar_items": {
      "category": "Sports",
      "description": "A safety helmet for cycling.",
      "id": 2,
      "lvl": 1,
      "name": "Helmet",
      "price": 49.99,
      "related_items": [
        1,
        3
      ]
    }
  },
  {
    "similar_items": {
      "category": "Sports",
      "description": "Comfortable gloves for cycling.",
      "id": 4,
      "lvl": 1,
      "name": "Gloves",
      "price": 19.99,
      "related_items": [
        1,
        3
      ]
    }
  },
  {
    "similar_items": {
      "category": "Sports",
      "description": "A sturdy and reliable bicycle.",
      "id": 1,
      "lvl": 2,
      "name": "Bicycle",
      "price": 299.99,
      "related_items": [
        2,
        4
      ]
    }
  },
  {
    "similar_items": {
      "category": "Accessories",
      "description": "A convenient water bottle for cycling.",
      "id": 3,
      "lvl": 2,
      "name": "Water Bottle",
      "price": 9.99,
      "related_items": [
        2,
        4
      ]
    }
  }
]</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Solution using the CYCLE clause to track which fields are likely to repeat and cause a cycle</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-sqlpp hljs" data-lang="sqlpp">WITH RECURSIVE similar_items AS (
  SELECT p.*, 0 as lvl FROM products p WHERE p.id=1
    UNION
  SELECT p1.*, similar_items.lvl+1 as lvl FROM products p1,
    similar_items WHERE p1.id IN similar_items.related_items
)
CYCLE id RESTRICT
SELECT * FROM similar_items;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Results</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">[
  {
    "similar_items": {
      "category": "Sports",
      "description": "A sturdy and reliable bicycle.",
      "id": 1,
      "lvl": 0,
      "name": "Bicycle",
      "price": 299.99,
      "related_items": [
        2,
        4
      ]
    }
  },
  {
    "similar_items": {
      "category": "Sports",
      "description": "A safety helmet for cycling.",
      "id": 2,
      "lvl": 1,
      "name": "Helmet",
      "price": 49.99,
      "related_items": [
        1,
        3
      ]
    }
  },
  {
    "similar_items": {
      "category": "Sports",
      "description": "Comfortable gloves for cycling.",
      "id": 4,
      "lvl": 1,
      "name": "Gloves",
      "price": 19.99,
      "related_items": [
        1,
        3
      ]
    }
  },
  {
    "similar_items": {
      "category": "Accessories",
      "description": "A convenient water bottle for cycling.",
      "id": 3,
      "lvl": 2,
      "name": "Water Bottle",
      "price": 9.99,
      "related_items": [
        2,
        4
      ]
    }
  }
]</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>Â© 2024 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Server","components":["server"],"url":"/home/server.html","latestVersions":{"server":"7.6"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../../_/js/vendor/chatbox-ui.js"></script>
<script id="site-script" src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab"></script>
<script defer src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
