<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://metrics.couchbase.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
<!-- End Google Tag Manager -->
<title>Configure Server Certificates | Couchbase Docs</title>
<link rel="canonical" href="https://docs.couchbase.com/server/current/manage/manage-security/configure-server-certificates.html">
<link rel="stylesheet" href="../../../../_/css/site.css">
<script src="../../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Couchbase Server Enterprise Edition supports using X.509 and PKCS #12 certificates for authenticating and encrypting data between the nodes in the cluster.">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="7.6">
<meta name="page-url" content="/server/current/manage/manage-security/configure-server-certificates.html">
<meta name="page-nav-header-levels" content="0">

<meta name="docsearch:component" content="server">
<meta name="docsearch:component_title" content="Couchbase Server">
<meta name="docsearch:cversion" content="7.6">
<meta name="docsearch:component_version" content="server@7.6">
<meta name="docsearch:module" content="manage">
<meta name="docsearch:breadcrumbs" content="Couchbase Server / Manage / Manage Security / Manage Authentication / Manage Certificates / Configure Server Certificates">
<meta name="docsearch:topic_type" content="">
<meta name="docsearch:version_rank" content="1">
<meta name="docsearch:status" content="">
<meta name="docsearch:edition" content="">
<meta name="docsearch:page_rank" content="50">


<meta name="generator" content="Antora 3.1.4">
<link rel="icon" href="../../../../_/img/favicon.svg" type="image/svg+xml">
<link rel="icon" href="../../../../_/img/favicon.ico" type="image/x-icon" sizes="any">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation"
                      href="https://docs.couchbase.com/home/index.html">
                    <img src="../../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">

                  <li class="nav-item "">
                    <a href="https://docs.couchbase.com/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item nav-item-selected">
                    <a class="nav-link" href="../../../../home/server.html">
                      Server
                      
                    </a>
                  </li>
                  <li class="nav-item ">
                    <a class="nav-link" href="../../../../home/mobile.html">
                      Mobile
                      
                    </a>
                  </li>
                  <li class="nav-item ">
                    <a class="nav-link" href="../../../../cloud/index.html">
                      Capella
                      
                    </a>
                  </li>
                  <li class="nav-item ">
                    <a class="nav-link" href="../../../../home/sdk.html">
                      SDKs
                      
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>
              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
    <template id="page-versions" style="display: none">
      <select class="version_list" data-component="server">
        <option value="7.6" data-url="configure-server-certificates.html" selected>7.6</option>
        <option value="7.2" data-url="../../../7.2/manage/manage-security/configure-server-certificates.html">7.2</option>
        <option value="7.1" data-url="../../../7.1/index.html">7.1</option>
        <option value="7.0" data-url="../../../7.0/index.html">7.0</option>
      </select>
    </template>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/rayoffiah/projects/couchbase/docs-server/modules/manage/pages/manage-security/configure-server-certificates.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../../introduction/intro.html">Couchbase Server</a></li>
<li class="crumb">Manage</li>
<li class="crumb"><a href="security-management-overview.html">Manage Security</a></li>
<li class="crumb"><a href="manage-authentication.html">Manage Authentication</a></li>
<li class="crumb"><a href="manage-certificates.html">Manage Certificates</a></li>
<li class="crumb"><a href="configure-server-certificates.html">Configure Server Certificates</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">Configure Server Certificates</h1>
<div class="labels">
<ul></ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="quoteblock abstract">
<blockquote>
Couchbase Server Enterprise Edition supports using X.509 and PKCS #12 certificates for authenticating and encrypting data between the nodes in the cluster.
</blockquote>
</div>
<div class="paragraph">
<p>This page explains how to configure server certificates for Couchbase Server Enterprise Edition.
For an overview of how Couchbase Server uses certificates, see  <a href="../../learn/security/certificates.html" class="xref page">Certificates</a>.</p>
</div>
<div class="paragraph">
<p>The procedures in this page are only limited examples.
They cover the basic steps for creating certificates.
When creating and deploying certificates for your own database, you often have to modify these steps to suit your environment.</p>
</div>
<div class="paragraph">
<p>This page gives detailed steps to configure X.509 certificates on a Linux-based single node Couchbase Server.
It demonstrates two scenarios.
The first shows directly signing the node&#8217;s certificate using the root certificate.
The second shows creating an intermediate certificate from the root certificate and using that to sign the node&#8217;s certificate.</p>
</div>
<div class="paragraph">
<p>This page also explains how you can bundle certificates, private keys, and certificate chains into a single Public-Key Cryptography Standard (PKCS) #12 certificate file.
Couchbase Server supports using this type of file to upload node certificates.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Once you deploy cluster and node certificates to a database, you must create additional node certificates for any new nodes you add later.
See <a href="#adding-new-cluster-nodes">Adding New Cluster Nodes</a> for details.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="root-and-node-certificates"><a class="anchor" href="#root-and-node-certificates"></a>Create and Deploy Cluster and Node Certificates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following procedure shows how to create a  self-signed root certificate for a single-node database.
It then demonstrates using that certificate to sign a node certificate.
The steps for a multi-node cluster are similar, as explained at the end of the example.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a command line shell on the node.</p>
</li>
<li>
<p>In some directory (such as your home directory or <code>/tmp</code>) create working directories:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">mkdir servercertfiles
cd servercertfiles
mkdir -p {public,private,requests}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, each directory has a different purpose:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>public</code> directory stores certificates, which contain public keys.</p>
</li>
<li>
<p>The <code>private</code> directory contains private keys.</p>
</li>
<li>
<p>The <code>requests</code> directory stores certificate signing requests.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Create a private key for the cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">openssl genrsa -out ca.key 2048</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of this command, <code>ca.key</code>, is the private key for the cluster.</p>
</div>
</li>
<li>
<p>Create the certificate (the file that contains the public key) for the cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">openssl req -new -x509 -days 3650 -sha256 -key ca.key -out ca.pem \
        -subj "/CN=Couchbase Root CA"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The arguments to this command are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>-x509</code>: generates an X.509 format certificate.</p>
</li>
<li>
<p><code>-days 3650</code>: the number of days before the certificate expires.</p>
</li>
<li>
<p><code>-sha256</code> the hashing algorithm to use for the digital signature.</p>
</li>
<li>
<p><code>-key ca.key</code>: sets the private key file the certificate is based on to the private key you created in the previous step.</p>
</li>
<li>
<p><code>-out ca.pem</code>: the filename for the certificate.</p>
</li>
<li>
<p><code>-subj "/CN=Couchbase Root CA"</code>: the <code>/CN=</code> portion of the argument sets the common name of the certificate&#8217;s issuer to <code>Couchbase Root CA</code>.
This name identifies the certificate as the root certificate for the Couchbase Server cluster.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Optionally, you can review the content of the certificate you just created using the command:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">openssl x509 -text -noout -in ./ca.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following is an example of the first part of the output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 18276610881715621025 (0xfda390c366b2cca1)
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN=Couchbase Root CA
        Validity
            Not Before: Sep  2 08:32:31 2019 GMT
            Not After : Aug 30 08:32:31 2029 GMT
        Subject: CN=Couchbase Root CA
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                    00:d7:a6:ba:5d:e2:e2:fd:6e:1b:33:9a:4b:bf:77:
                    6f:28:c3:37:60:33:da:09:b2:0b:73:1f:f9:65:2a:
                                  .
                                  .</pre>
</div>
</div>
<div class="paragraph">
<p>For detailed information about keys and key generation, see <a href="https://en.wikipedia.org/wiki/RSA_(cryptosystem)">RSA (cryptosystem)</a>.</p>
</div>
</li>
<li>
<p>Create a private key for the node.
Each node in the cluster needs its own private key and certificate.
Couchbase Server requires that you name the file containing the private key <code>pkey.key</code>.
However, if you&#8217;re creating private keys for multiple nodes, you&#8217;ll need to give them unique filenames to avoid them overwriting each other.
This example gives it a unique name, which you&#8217;ll need to change when you deploy the private key to the node.</p>
<div class="paragraph">
<p>The command to create a private key is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">openssl genrsa -out private/couchbase.default.svc.key 2048</code></pre>
</div>
</div>
</li>
<li>
<p>Create a Certificate Signing Request (CSR) for the node certificate:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">openssl req -new -key private/couchbase.default.svc.key \
        -out requests/couchbase.default.svc.csr -subj "/CN=Couchbase Server"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This step prepares the request you use to sign the node&#8217;s certificate with the cluster&#8217;s private key and certificate later.</p>
</div>
</li>
<li>
<p>Create a file that contains the certificate extensions that all nodes have in common.
These extensions define constraints on how a certificate can be used.
For detailed information about certificate extensions, see the <a href="https://tools.ietf.org/html/rfc5280#section-4.2.1" target="_blank" rel="noopener">Standard Extensions</a> section of the <a href="https://tools.ietf.org/html/rfc5280" target="_blank" rel="noopener">Internet X.509 Public Key Infrastructure Certificate and Certificate Revocation List (CRL Profile)</a>.
You submit the extensions to the signing CA, along with the CSR you generated in the previous step.
The next step adds information specific to an individual node.</p>
<div class="paragraph">
<p>Use this command to create the certificate extension file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">cat &gt; server.ext &lt;&lt;EOF
basicConstraints=CA:FALSE
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer:always
extendedKeyUsage=serverAuth
keyUsage = digitalSignature,keyEncipherment
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>The extensions in this file are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>basicConstraints=CA:FALSE</code>: the certificate generated from the CSR cannot be used to issue other certificates.</p>
</li>
<li>
<p><code>subjectKeyIdentifier = hash</code>: the Subject Key Identifier (SKI) is derived form a hash of the public key in the certificate.</p>
</li>
<li>
<p><code>authorityKeyIdentifier = keyid,issuer:always</code>: specifies how to generate Authority Key Identifier (AKI).
The <code>keyid</code> tells the certificate signing process to generate the AKI from the issuer&#8217;s public key (the cluster&#8217;s public key, in this example).
The <code>issuer:always</code>: means that the signing process always includes the issuer&#8217;s distinguished name (DN)in the AKI.</p>
</li>
<li>
<p><code>extendedKeyUsage=serverAuth</code>: means that the purpose of the certificate being signed is for server identification.</p>
</li>
<li>
<p><code>keyUsage</code>: limits how the private key can be used.
The values <code>digitalSignature,keyEncipherment</code> mean you can use the private key for digital signatures and for encipherment.
Encipherment means that the key&#8217;s primary use is to encrypt session or  symmetric keys, but it can also be used for direct data encryption.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Create a customized version of the certificate extensions file that contain settings specific to the node:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">cp ./server.ext ./server.ext.tmp

echo "subjectAltName = IP:10.143.192.102" \
&gt;&gt; ./server.ext.tmp</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command copies the file created in the previous step and adds a <code>subjectAltName</code> extension that identifies the node.
This example uses the node&#8217;s IPv4 address.
This extension makes sure the node&#8217;s certificate is valid for just the specific node.
No other node or client can use the certificate.
If your cluster uses DNS names to identify nodes, you must use the node&#8217;s DNS name, such as <code>DNS:node2.cb.com</code> instead of its IP address.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Couchbase Enterprise Server requires that the node&#8217;s certificate identifies the node in a Subject Alternative Name extension.
Without this identification, Couchbase Server reports an error when you upload the certificate to the node or when you try to add the node to the cluster.
For more information, see <a href="../../learn/security/certificates.html#node-certificate-validation" class="xref page">Node-Certificate Validation</a>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Create the node&#8217;s certificate by signing it with the certificate and digital signature of the CA.
In this example, the CA is the root certificate created earlier.
Therefore, the command to sign the node&#8217;s certificate uses the <code>ca.pem</code> and <code>ca.key</code> files:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">openssl x509 -CA ca.pem -CAkey ca.key -CAcreateserial -days 365 -req \
    -in requests/couchbase.default.svc.csr \
    -out public/couchbase.default.svc.pem \
    -extfile server.ext.tmp</code></pre>
</div>
</div>
<div class="paragraph">
<p>The arguments to this command are:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>x509</code>: specifies that <code>openssl</code> is working with an X.509 certificate.</p>
</li>
<li>
<p><code>-CA ca.pem -CAkey ca.key</code>: tells <code>openssl</code> to use the key and certificate created in steps 1 and 2 as the CA.</p>
</li>
<li>
<p><code>-CAcreateserial</code>: tells <code>openssl</code> to create a serial number file if it does not already exist.
It then writes the serial number it assigns to the certificate to this file.
The serial file records the serial numbers of all the certificates <code>openssl</code> creates to make sure each certificate it creates has a unique serial number.</p>
</li>
<li>
<p><code>-days 365</code>: sets the number of days before the certificate expires.</p>
</li>
<li>
<p><code>-req</code>: tells <code>openssl</code> that you want to read a CSR to perform a certificate signing.</p>
</li>
<li>
<p><code>-in requests/couchbase.default.svc.csr</code>: has <code>openssl</code> read the CSR created in step 6.</p>
</li>
<li>
<p><code>out public/couchbase.default.svc.pem</code>: tells <code>openssl</code> sets where to save the signed node certificate.</p>
</li>
<li>
<p><code>-extfile server.ext.tmp</code>: tells <code>openssl</code> to read the extensions  file created in step 9.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>The file generated by this command, <code>couchbase.default.svc.pem</code>, is the node&#8217;s certificate.</p>
</div>
<div class="paragraph">
<p>The output of running the previous command looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Signature ok
subject=/CN=Couchbase Server
Getting CA Private Key</code></pre>
</div>
</div>
</li>
<li>
<p>Before you can deploy the key private key and the certificate to the node, you must rename their files.
Couchbase Server requires that these files have specific filenames.
Rename the certificate file to <code>chain.pem</code> and the private key file to <code>pkey.key</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">cd ./public
mv couchbase.default.svc.pem chain.pem
cd ../private
mv couchbase.default.svc.key pkey.key</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In this example you could just have <code>openssl</code> output the correct filenames in steps 5 and 9.
In production, you often create certificates for multiple nodes at the same time, and so need to give each file a unique name.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>If the node to which you&#8217;re deploying the certificate does not have an inbox directory, create it.
The inbox directory is where Couchbase Server looks for certificate, key, and related files.
See <a href="../../rest-api/load-trusted-cas.html" class="xref page">Load Root Certificates</a> for a list of the inbox paths on all platforms.
On Linux, this directory is <code>/opt/couchbase/var/lib/couchbase/inbox/</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">sudo mkdir /opt/couchbase/var/lib/couchbase/inbox/</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the node certificate and node private key by copying them to the <code>inbox</code> directory.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">cd ..
sudo cp ./public/chain.pem /opt/couchbase/var/lib/couchbase/inbox/chain.pem
sudo cp ./private/pkey.key /opt/couchbase/var/lib/couchbase/inbox/pkey.key</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
This example has a single node, so you created the node&#8217;s certificate on the node where you&#8217;ll deploy it.
Therefore, you can just copy the files into the correct directory using <code>cp</code>.
When creating certificates for multiple nodes, you must move the files to the node&#8217;s filesystem to deploy them.
If you created all of the certificates on one node, you can use a command such as <code>scp</code> to copy the files from that node to the node the certificate is for.
Remember to create the <code>inbox</code> directory on each node as well.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Deploy the root certificate.
Couchbase Server expects to find the root certificate in a subdirectory named <code>CA</code> in the <code>inbox</code> directory.
Create the subdirectory and then copy the root CA file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">sudo mkdir /opt/couchbase/var/lib/couchbase/inbox/CA
sudo cp ./ca.pem /opt/couchbase/var/lib/couchbase/inbox/CA/.</code></pre>
</div>
</div>
</li>
<li>
<p>Make all files in the <code>inbox</code> directory readable by just the <code>couchbase</code> user:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">sudo chown -R couchbase /opt/couchbase/var/lib/couchbase/inbox/*
sudo chmod -R 0700 /opt/couchbase/var/lib/couchbase/inbox/*</code></pre>
</div>
</div>
</li>
<li>
<p>Call the REST API to have Couchbase Server load the root certificate for the cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">curl -X POST http://10.143.192.102:8091/node/controller/loadTrustedCAs -u Administrator:password</code></pre>
</div>
</div>
</li>
<li>
<p>Optionally, verify that Couchbase Server has added the new root CA to its trust store:</p>
<div class="openblock">
<div class="content">
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Sign into the Couchbase Server Web Console as a Full Administrator.</p>
</li>
<li>
<p>Click <b class="menuref">Security</b>, and click <b class="menuref">Certificates</b></p>
</li>
</ol>
</div>
</div>
</div>
<div id="see-root-certificate-with-couchbase-web-console" class="paragraph">
<p>In this example, you can see both the original automatically generated root certificate and the newly uploaded certificate.
The original generated root certificate appears at the top.</p>
</div>
<div class="imageblock text-left">
<div class="content">
<img src="../_images/manage-security/rootCertificateWithSignedCert.png" alt="600">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You cannot delete a certificate if it has signed one or more node certificates that are in use in the cluster.
You can only delete the old autogenerated certificate after you have deployed new node certificates signed by the new root CA to each node.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For more information about the <strong>Certificates</strong> tab on the <strong>Security</strong> screen, see <a href="manage-security-settings.html#root-certificate-security-screen-display" class="xref page">Certificates</a>.</p>
</div>
</li>
<li>
<p>Load the node certificate and its private key by calling the <a href="../../rest-api/upload-retrieve-node-cert.html" class="xref page">reloadCertificate</a> REST API:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">curl -X POST http://10.143.192.102:8091/node/controller/reloadCertificate -u Administrator:password</code></pre>
</div>
</div>
<div class="paragraph">
<p>The node certificate is now activated for the current node, bearing the authority of the root CA.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>For more information using the REST API to manage certificates, see <a href="../../rest-api/rest-certificate-management.html" class="xref page">Certificate Management API</a>.
This includes details on retrieving root and nodes certificates that have been uploaded, and on certificate deletion.</p>
</div>
<div class="paragraph">
<p>This example demonstrated configuring certificates for a single node database.
To deploy certificates for a multi-node cluster, repeat steps 6, 7, 9, 10, 11, 12, 15, and 18 for each node.
Remember that you must copy the node&#8217;s certificate and key files to its own <code>inbox</code> directory to deploy them.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="root-intermediate-and-node-certificates"><a class="anchor" href="#root-intermediate-and-node-certificates"></a>Create and Use Intermediate Certificates to Sign Node Certificates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The previous example directly signed node certificates using the root certificate.
In some cases, you may want to use an intermediate certificate to sign the certificates for the nodes.
The primary reason to use an intermediate certificate is to prevent exposing the cluster&#8217;s private key.</p>
</div>
<div class="paragraph">
<p>For example, you may want to delegate the signing of node certificates.
By creating an intermediate certificate, you can keep the cluster&#8217;s private key secret while allowing others to sign node certificates.
The administrators to whom you delegate the signing of node certificates can use the intermediate certificate for signing.
They do not need use to the cluster&#8217;s private key to sign the node certificates.</p>
</div>
<div class="paragraph">
<p>For more information, see <a href="../../learn/security/using-multiple-cas.html#adding-intermediate-certificates-to-the-trust-store" class="xref page">Adding Intermediate Certificates to the Trust Store</a>.</p>
</div>
<div class="paragraph">
<p>When a peer (such as another node or a client) attempts to connect to a node securely, it uses the node&#8217;s certificate to verify the node&#8217;s identity.
The node can supply a chain of certificates to the peer in addition to its own.
To verify the node&#8217;s identity, the peer searches for a CA it trusts in the chain of certificates from the node.
See <a href="../../learn/security/certificates.html#intermediate-certificates" class="xref page">Intermediate Certificates</a> for more information.</p>
</div>
<div class="paragraph">
<p>In Couchbase Server you can supply the peer with the chain of trust it needs to identify the node in one of two ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Concatenation of all intermediate and node certificates into a single <code>chain.pem</code> file, which you deploy to the node.
The node provides this entire chain of trust to the peer when it tries to connect securely.</p>
</li>
<li>
<p>Deploy a <code>chain.pem</code> file containing just the node&#8217;s certificate.
In this case, the peer&#8217;s trust store must already have all intermediate certificates that it needs to verify the node&#8217;s identity.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following examples demonstrate both of these methods.
They assume that you have already completed the steps in <a href="#root-and-node-certificates">Create and Deploy Cluster and Node Certificates</a>.</p>
</div>
<div class="sect2">
<h3 id="intermediate-concatenation"><a class="anchor" href="#intermediate-concatenation"></a>Deploy an Intermediate Certificate as Part of the Node&#8217;s Trust Chain</h3>
<div class="paragraph">
<p>This example demonstrates creating root, node, intermediate, and client certificates.
It Concatenates these certificates together so the node can provide the client a complete chain of trust.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open a command line shell on the node for which you want to create a certificate signed by an intermediate certificate.</p>
</li>
<li>
<p>In some directory, such as your home directory or <code>/tmp</code>, create working directories:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">mkdir servercertfiles2
cd servercertfiles2
mkdir -p {root,servers,clients}/{issued,reqs,private}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll use the <code>root</code>, <code>servers</code>, and <code>clients</code> directories to contain the certificates, requests, and private keys for the root, node, and client certificates.
The <code>issued</code>, <code>reqs</code>, and <code>private</code> subdirectories in these directories will contain the final certificates, the signing requests, and the private keys respectively.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The example <a href="configure-client-certificates.html#client-certificate-authorized-by-an-intermediate-certificate" class="xref page">Client Access: Intermediate Certificate Authorization</a> uses this directory structure.
It demonstrates creating the certificates that the clients need.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Change to the <code>root</code> directory and create a configuration file for the root certificate:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">cd root

cat &gt; config &lt;&lt;EOF
[req]
distinguished_name = cn_only
x509_extensions = ca_ext
[ cn_only ]
commonName = Common Name (eg: your user, host, or server name)
commonName_max = 64
commonName_default = CA
[ca_ext]
basicConstraints = CA:TRUE
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer:always
keyUsage = cRLSign, keyCertSign
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>config</code> file has three sections:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>[req]</code> specifies  the values to pass to the <code>req</code> command.
This command creates and processes certificate requests.
To learn more about it and its arguments, use the command <code>man req</code>.</p>
</li>
<li>
<p><code>[cn_only]</code> provides specifications for the Common Name to used in the certificate, including the maximum number of characters and the default name.</p>
</li>
<li>
<p><code>[ca_ext]</code> provides basic extensions that limit the capability of the certificate.
Some of the settings in this section are:</p>
<div class="ulist">
<ul>
<li>
<p><code>basicConstraints  CA:TRUE</code> makes the certificate capable of signing other certificates.</p>
</li>
<li>
<p><code>keyUsage = cRLSign, keyCertSign</code> has two effect.
The <code>cRLSign</code> value prevents the certificate&#8217;s public key from being able to verify signatures on Certificate Revocation Lists.
And <code>keyCertSign</code> makes the certificate&#8217;s public key able to verify signatures on other certificates.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Create the root certificate, passing in the <code>config</code> file you just created:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">openssl req -config config -new -x509 -days 3650 -sha256 -newkey rsa:2048 \
    -keyout ca.key -out ca.pem -subj '/C=UA/O=MyCompany/CN=RootCA'</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command creates both the root certificate for the cluster in a file named <code>ca.pem</code> file, and the private key in a file named <code>ca.key</code>.
The <code>-keyout</code> argument tells <code>openssl</code> to password protect the private key.
When executing the command, <code>openssl</code> prompts you for a pass phrase:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">Generating a 2048 bit RSA private key
....+++
...................+++
writing new private key to 'ca.key'
Enter PEM pass phrase:</code></pre>
</div>
</div>
<div class="paragraph">
<p>Anyone trying to use the certificate&#8217;s private key must enter this passphrase.</p>
</div>
</li>
<li>
<p>Create an extensions file to limit the capabilities of the intermediate certificate that you create in the next step:</p>
<div id="create-intermediate-extensions-file" class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">cat &gt; int.ext &lt;&lt;EOF
basicConstraints = CA:TRUE
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer:always
keyUsage = cRLSign, keyCertSign
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with the root certificate configuration, this configuration&#8217;s <code>basicConstraints</code> setting allows the intermediate certificate to sign other certificates.
Its <code>keyUsage</code> setting also allows the certificate&#8217;s public key to verify its signature on other certificates.</p>
</div>
</li>
<li>
<p>Create a private key and a corresponding certificate signing request for the intermediate certificate:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">openssl req -new -sha256 -newkey rsa:2048 -keyout ../servers/int.key \
    -out reqs/server-signing.csr \
    -subj '/C=UA/O=MyCompany/OU=Servers/CN=ServerSigningCA'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again, the command requires <code>openssl</code> to password protect the private key, so it prompts you twice for a pass phrase.</p>
</div>
<div class="paragraph">
<p>The command outputs the encrypted private key in <code>servers/int.key</code> and a signing request in <code>root/req/server-signing.csr</code>.</p>
</div>
</li>
<li>
<p>Create the intermediate certificate signed by the root certificate <code>ca.pem</code> and its key <code>ca.key</code>, to establish the intermediate certificate&#8217;s authority:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">openssl x509 -CA ca.pem -CAkey ca.key -CAcreateserial \
    -CAserial serial.srl -days 3650 -req -in reqs/server-signing.csr \
    -out issued/server-signing.pem -extfile int.ext</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>openssl</code> prompts you for the pass phrase for the <code>ca.key</code> private key because you password-protected it in an earlier step.
The command saves the intermediate certificate as <code>issued/server-signing.pem</code>.</p>
</div>
</li>
<li>
<p>Make a copy of the intermediate certificate to use as the authority for the node certificates that you create in later steps.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">cp issued/server-signing.pem ../servers/int.pem</code></pre>
</div>
</div>
</li>
<li>
<p>Within the <code>../servers</code> directory, create an extension file containing the information that&#8217;s common across all nodes in the cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">cd ../servers

cat &gt; server.ext &lt;&lt;EOF
basicConstraints = CA:FALSE
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer:always
extendedKeyUsage = serverAuth
keyUsage = digitalSignature,keyEncipherment
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some of the important values in this extension file are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>extendedKeyUsage = serverAuth</code> limits the purpose of the certificate to server authentication.</p>
</li>
<li>
<p><code>keyUsage</code> value <code>digitalSignature</code> specifies that the certificate&#8217;s public key can be used in the verifying of information-origin.
The <code>keyEncipherment</code> value allows the public key to encrypt symmetric keys.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Generate the private key for the node.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">openssl genrsa -out private/couchbase.node.svc.key 2048</code></pre>
</div>
</div>
</li>
<li>
<p>Generate a certificate signing request for the node&#8217;s certificate.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">openssl req -new -key private/couchbase.node.svc.key \
    -out reqs/couchbase.node.svc.csr \
    -subj "/C=UA/O=MyCompany/OU=Servers/CN=couchbase.node.svc"</code></pre>
</div>
</div>
</li>
<li>
<p>Create a copy of the file containing the certificate extensions and append a setting specific to the node.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">cp server.ext temp.ext

echo 'subjectAltName = IP:10.143.192.102' &gt;&gt; temp.ext</code></pre>
</div>
</div>
<div class="paragraph">
<p>The newly created <code>temp.ext</code> file adds the node&#8217;s IP address as a Subject Alternative Name to the certificate.
In Couchbase Enterprise Server Version 7.2 and later, you must add a Subject Alternative Name to the certifcate which indentifies the node.
If the certificate&#8217;s Subject Alternative Name does not match the node&#8217;s identity in the cluster, Couchbase Server returns an error if you try to load the certificate.
For information and options, see <a href="../../learn/security/certificates.html#server-certificate-validation" class="xref page">Server Certificate Validation</a>.</p>
</div>
</li>
<li>
<p>Create the node certificate for the node by signing the certification request you just created using the intermediate certificate:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">openssl x509 -CA int.pem -CAkey int.key -CAcreateserial \
    -CAserial serial.srl -days 365 -req -in reqs/couchbase.node.svc.csr \
    -out issued/couchbase.node.svc.pem -extfile temp.ext</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because you&#8217;re using the intermediate certificate in this signing request, <code>openssl</code> prompts you to enter the pass phrase for the intermediate certificate&#8217;s private key.</p>
</div>
<div class="paragraph">
<p>The command creates the node&#8217;s certificate as the file <code>issued/couchbase.node.svc.pem</code></p>
</div>
</li>
<li>
<p><a id="check-validity"></a>Check that the node certificate is valid.
The following use of the <code>openssl</code> command verifies the relationship between the root certificate, the intermediate certificate, and the node certificate.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">openssl verify -trusted ../root/ca.pem -untrusted int.pem \
    issued/couchbase.node.svc.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command outputs the following if the certificate passes the validity check:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>issued/couchbase.node.svc.pem: OK</pre>
</div>
</div>
</li>
<li>
<p>Prepare the node&#8217;s certificate for upload by creating the <code>chain.pem</code> certificate file.
You create <code>chain.pem</code> by concatenating the node certificate and the intermediate certificate to establish the chain of authority.
Couchbase Server expects the node&#8217;s certificate file to be named <code>chain.pem</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">cat issued/couchbase.node.svc.pem int.pem &gt; chain.pem</code></pre>
</div>
</div>
</li>
<li>
<p>Create a copy of the node&#8217;s private key named <code>pkey.key</code> for deployment to the node.
Couchbase Server expects the node&#8217;s private key to have this filename.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">cp private/couchbase.node.svc.key pkey.key</code></pre>
</div>
</div>
</li>
<li>
<p>Move the node certificate and node private key into the <code>inbox</code> directory for the current node.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">sudo mkdir /opt/couchbase/var/lib/couchbase/inbox/

sudo cp ./chain.pem /opt/couchbase/var/lib/couchbase/inbox/chain.pem
sudo cp ./pkey.key /opt/couchbase/var/lib/couchbase/inbox/pkey.key</code></pre>
</div>
</div>
</li>
<li>
<p>Move the root certificate into the <code>inbox/CA</code> directory for the current node.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">sudo mkdir /opt/couchbase/var/lib/couchbase/inbox/CA/
cd ../root
sudo cp ca.pem /opt/couchbase/var/lib/couchbase/inbox/CA/.</code></pre>
</div>
</div>
</li>
<li>
<p>Make all certificate and private key files in the <code>inbox</code> readable by the <code>couchbase</code> user.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">sudo chown -R couchbase /opt/couchbase/var/lib/couchbase/inbox/*
sudo chmod -R 0700 /opt/couchbase/var/lib/couchbase/inbox/*</code></pre>
</div>
</div>
</li>
<li>
<p>Upload the root certificate, activating it for the entire cluster.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">curl -X POST http://10.143.192.102:8091/node/controller/loadTrustedCAs \
     -u Administrator:password</code></pre>
</div>
</div>
</li>
<li>
<p>Upload the node certificate.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">curl -X POST http://10.143.192.102:8091/node/controller/reloadCertificate \
    -u Administrator:password</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>For more information using the REST API to manage certificates, see <a href="../../rest-api/rest-certificate-management.html" class="xref page">Certificate Management API</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="intermediate-upload"><a class="anchor" href="#intermediate-upload"></a>Deploy an Intermediate Certificate via Peer&#8217;s Trust Store</h3>
<div class="paragraph">
<p>The following example creates an intermediate certificate but does not concatenate it with the node&#8217;s certificate.
After following these steps, any peer attempting to make a secure TLS connection to the node must have the intermediate certificate in its trust store.
These peers include clients making secure connections and other nodes in the Couchbase Server cluster.
Adding the intermediate certificate to the peer&#8217;s trust store makes sure the peer can establish a chain of trust from the node&#8217;s certificate to a CA that it trusts.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Perform all steps listed in the section <a href="#intermediate-concatenation">Deploy an Intermediate Certificate as Part of the Node&#8217;s Chain</a> up to and including step #14, <a href="#check-validity">Check that the node certificate is valid</a>.</p>
</li>
<li>
<p>Prepare to deploy the certificate and private key for the node, by renaming both:</p>
<div class="listingblock">
<div class="content">
<pre>cp issued/couchbase.node.svc.pem chain.pem

cp private/couchbase.node.svc.key pkey.key</pre>
</div>
</div>
</li>
<li>
<p>Move the renamed node certificate and private key into the <code>inbox</code> for the current node.</p>
<div class="listingblock">
<div class="content">
<pre>sudo mkdir /opt/couchbase/var/lib/couchbase/inbox/

sudo cp ./chain.pem /opt/couchbase/var/lib/couchbase/inbox/chain.pem
sudo cp ./pkey.key /opt/couchbase/var/lib/couchbase/inbox/pkey.key</pre>
</div>
</div>
</li>
<li>
<p>Move the root certificate and the intermediate certificate into the <code>inbox/CA</code> directory for the current node.</p>
<div class="listingblock">
<div class="content">
<pre>sudo mkdir /opt/couchbase/var/lib/couchbase/inbox/CA/  # if needed
sudo cp int.pem /opt/couchbase/var/lib/couchbase/inbox/CA/.
cd ../root
sudo cp ca.pem /opt/couchbase/var/lib/couchbase/inbox/CA/.</pre>
</div>
</div>
</li>
<li>
<p>Make sure that all certificate and private key files in the <code>inbox</code> directory can be read by user <code>couchbase</code>.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">sudo chown -R couchbase /opt/couchbase/var/lib/couchbase/inbox/*
sudo chmod -R 0700 /opt/couchbase/var/lib/couchbase/inbox/*</code></pre>
</div>
</div>
</li>
<li>
<p>Upload the root and intermediate certificates.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">curl -X POST http://10.143.192.102:8091/node/controller/loadTrustedCAs \
     -u Administrator:password</code></pre>
</div>
</div>
</li>
<li>
<p>Upload the node certificate.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">curl -X POST http://10.143.192.102:8091/node/controller/reloadCertificate
     -u Administrator:password</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When the cluster contains more than one node, you must repeat the call to <code>/node/controller/reloadCertificate</code> for each node.
Be sure to use the IP address of each node in the POST URL to have each node reload its certificates.
Also, copy the files to the node&#8217;s inbox on its own filesystem.
The files must be on the node for the REST API call to work.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>The node&#8217;s certificate is now deployed.
Remember that it does not contain the intermediate certificate.
For a peer to identify the node, it must have a copy of the intermediate certificate in its trust store.
Without it, the peer cannot establish a chain of trust from the node to the root CA.
To make sure other nodes in the cluster can identify the node, add the intermediate certificate to the Couchbase Server&#8217;s trust store.
For other clients, consult their documentation to determine how to add the intermediate certificate to their trust stores.</p>
</div>
<div class="paragraph">
<p>For more information using the REST API to manage certificates, see <a href="../../rest-api/rest-certificate-management.html" class="xref page">Certificate Management API</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pkcs12"><a class="anchor" href="#pkcs12"></a>Deploy a Certificate and Private Key to a Node in a PKCS #12 File</h2>
<div class="sectionbody">
<div class="paragraph">
<p>PKCS #12 format certificates let you bundle certificates, private keys, and other objects into a single file.
Couchbase Server supports using PKCS #12 files for deploying certificates, private keys, and certificate chains for nodes.
It does not support using them for other purposes, such as client or root certificates.</p>
</div>
<div class="paragraph">
<p>Couchbase Server requires that the PKCS #12 file be in the node&#8217;s <code>inbox</code> directory with the filename <code>couchbase.p12</code>.</p>
</div>
<div class="paragraph">
<p>The following example demonstrates how to bundle the node&#8217;s certificate and private key into a PKCS #12 file and deploy it on a node.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Follow steps 1 through 10 in the <a href="#root-and-node-certificates">Create and Deploy Cluster and Node Certificates</a> example.
When you complete these steps you&#8217;ll have certificates and private keys for the cluster and the node.</p>
</li>
<li>
<p>Bundle the node&#8217;s certificate and private key into a single PKCS #12 file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">openssl pkcs12 -export -out couchbase.p12 -inkey private/couchbase.default.svc.key
        -in public/couchbase.default.svc.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>The arguments in this command are:</p>
</div>
<div class="openblock">
<div class="content">
<div class="ulist">
<ul>
<li>
<p><code>pkcs12</code> tells <code>openssl</code> you want to work with a PCKS #12 certificate.</p>
</li>
<li>
<p><code>-export</code> tells <code>openssl</code> you want to create a new certificate.</p>
</li>
<li>
<p><code>-out couchbase.p12</code> sets the output filename.
The file is saved in the current directory with the name Couchbase Server expects for a PKCS #12 certificate.</p>
</li>
<li>
<p><code>-inkey private/couchbase.default.svc.key</code> tells the command to import the node&#8217;s private key from the file you created earlier.
It also has <code>openssl</code> password protect the private key.</p>
</li>
<li>
<p><code>-in public/couchbase.default.svc.pem</code> tells the command where to find the node&#8217;s certificate.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="paragraph">
<p>The command prompts you to enter a password for the private key twice.</p>
</div>
</li>
<li>
<p>If the node to which you&#8217;re deploying the certificate does not have an inbox directory, create it.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">sudo mkdir /opt/couchbase/var/lib/couchbase/inbox/</code></pre>
</div>
</div>
</li>
<li>
<p>Copy the PKCS #12 certificate to the node&#8217;s inbox:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">sudo cp couchbase.p12 /opt/couchbase/var/lib/couchbase/inbox/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure there are no other certificate files in the <code>inbox</code> directory.
If Couchbase Server finds both a <code>couchbase.p12</code> and <code>pkey.key</code> in the inbox directory, it cannot tell which file you intend to use for the certificate.
In this case, it returns an error when you try to upload the certificate to the node.</p>
</div>
</li>
<li>
<p>Deploy the root certificate.
Couchbase Server expects to find the root certificate in a subdirectory named <code>CA</code> in the <code>inbox</code> directory.
Create the subdirectory and then copy the root CA file:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">sudo mkdir /opt/couchbase/var/lib/couchbase/inbox/CA
sudo cp ./ca.pem /opt/couchbase/var/lib/couchbase/inbox/CA/.</code></pre>
</div>
</div>
</li>
<li>
<p>Make all files in the <code>inbox</code> directory readable by just the <code>couchbase</code> user:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">sudo chown -R couchbase /opt/couchbase/var/lib/couchbase/inbox/*
sudo chmod -R 0700 /opt/couchbase/var/lib/couchbase/inbox/*</code></pre>
</div>
</div>
</li>
<li>
<p>Call the REST API to have Couchbase Server load the root certificate for the cluster:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">curl -X POST http://10.143.192.102:8091/node/controller/loadTrustedCAs -u Administrator:password</code></pre>
</div>
</div>
</li>
<li>
<p>Load the node certificate and its private key by calling the <a href="../../rest-api/upload-retrieve-node-cert.html" class="xref page">reloadCertificate</a> REST API.
Because an earlier step password protected the private key, you must pass the password for it as an argument to the REST API call:</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">curl -X POST http://10.143.192.102:8091/node/controller/reloadCertificate \
     -u Administrator:password
     -d '{"privateKeyPassphrase": {"type": "plain", "password": "private-key-password"}}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The JSON value you pass to the command supplies the password for the private key in the PKCS #12 certificate as plain text.
Replace the <code>private-key-password</code> with the password you entered in step 2.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
This example sends the private key&#8217;s password in plaintext for simplicity.
In a production environment, consider using a more secure method of sending this password.
See <a href="../../rest-api/upload-retrieve-node-cert.html#json-passphrase-registration" class="xref page">JSON Passphrase Registration</a>
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Couchbase Server extracts the private key and certificate from the <code>couchbase.p12</code> file and activates them on the node.</p>
</div>
<div class="paragraph">
<p>This example has the node&#8217;s certificate directly signed by the root certificate.
If instead you need to use one or more intermediate certificates to sign the node&#8217;s certificate, you can choose to include them to establish a chain of trust.
You can include a chain of intermediate certificates by adding a <code>-chain</code> argument to the <code>openssl</code> command in step 2.
See OpenSSL&#8217;s <a href="https://www.openssl.org/docs/manmaster/man1/openssl-pkcs12.htmlp" target="_blank" rel="noopener">openssl-pkcs12</a> documentation for documentation on <code>-chain</code> and other arguments.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="encrypted-node-private-keys"><a class="anchor" href="#encrypted-node-private-keys"></a>Encrypted Node Private Keys</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can choose to encrypt the private key for nodes when uploading them.
You must register the passphrase so that the key can be securely retrieved and used when required.
See  <a href="#rest-api/upload-retrieve-node-cert.adoc" class="xref unresolved">Upload and Retrieve a Node Certificate</a> for details.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configure-client-access-advanced"><a class="anchor" href="#configure-client-access-advanced"></a>Configuring Client Access</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Once you have configured root, intermediate, and node certificates for the cluster, you can create client certificates so clients can securely connect.
You can choose to create an intermediate client certificate that itself inherits the authority of the root.
Client-certificate preparation varies, depending on the type of client.
For steps to prepare a client certificate to support connections between Couchbase Server databases, see <a href="configure-client-certificates.html#client-certificate-authorized-by-an-intermediate-certificate" class="xref page">Client Access: Intermediate-Certificate Authorization</a>.
For steps to prepare a certificate for a Java client, see <a href="configure-client-certificates.html#java-client-access-intermediate-certificate-authorization" class="xref page">Java Client Access: Intermediate-Certificate Authorization</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Client connections secured by client certificate must be enabled on the cluster.
See <a href="enable-client-certificate-handling.html" class="xref page">Enable Client-Certificate Handling</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-an-externally-provided-root-certificate"><a class="anchor" href="#using-an-externally-provided-root-certificate"></a>Using an Externally Provided Root Certificate</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The examples in this page create a self-signed root certificate and use that certificate&#8217;s private key to sign other certificates.
In production environments, you often want to use a node certificate signed by a well-known Certificate Authority.
In this case, the CA provides the root, intermediate, and node certificates for you.
The intermediate certificate is optional.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="adding-new-nodes"><a class="anchor" href="#adding-new-nodes"></a>Adding and Joining New Nodes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When a cluster uses the default auto-generated certificates, you do not need to generate a new certificate for new nodes.
Once you configure the cluster to use custom certificates, you must generate a new certificate when adding or joining new nodes to the cluster.
In Couchbase Server always adds or joins new nodes  over an encrypted connection.</p>
</div>
<div class="paragraph">
<p>When a cluster using custom certificates adds or joins a new node to itself, the new node must interact with an existing node.
This interaction requires both the existing node and new node verify each other&#8217;s identity using their chains of trust.
The easiest way to make sure the nodes can identify  each other by signing them with the same root certificate or the same intermediate certificate.
Otherwise, make sure each node&#8217;s trust store contain the intermediate or CA that signed the other node&#8217;s certificate.</p>
</div>
<div class="sect2">
<h3 id="readding-a-previously-removed-node"><a class="anchor" href="#readding-a-previously-removed-node"></a>Re-Adding Node</h3>
<div class="paragraph">
<p>When you remove a node from a cluster, Couchbase Server deletes its configuration including its certificates chains.
If you add the removed node back to the cluster, Couchbase Server adds it as a new node with a new configuration.
Therefore, you must make sure node has the appropriate root certificate and chain certificate.</p>
</div>
<div class="paragraph">
<p>For more information about removing  nodes, see <a href="../../learn/clusters-and-availability/removal.html" class="xref page">Removal</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="regenerating-default-certificates"><a class="anchor" href="#regenerating-default-certificates"></a>Regenerating Default Certificates</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When it creates the cluster, Couchbase Server generates default certificates for the cluster and initial node.
It also generates certificates for additional nodes you add later.
You can have Couchbase Server regenerate the certificates using a the REST API call.
This call has Couchbase Server generate a new self-signed root certificate and add it to its trust store.
It then creates new node certificates signed by the new root certificate, overwriting existing node certificates.
Any old auto-generated and custom root certificates remain in the cluster&#8217;s trust store.</p>
</div>
<div class="paragraph">
<p>For information about regenerating certificates, see <a href="../../rest-api/rest-regenerate-all-certs.html" class="xref page">Regenerate All Certificates</a>.
For information about deleting root certificates, see <a href="../../rest-api/delete-trusted-cas.html" class="xref page">Delete Root Certificates</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="further-information"><a class="anchor" href="#further-information"></a>Further Information</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For information about certificate-management using the REST API, see <a href="../../cli/cbcli/couchbase-cli-ssl-manage.html" class="xref page">ssl-manage</a> and <a href="../../rest-api/rest-certificate-management.html" class="xref page">Certificate Management API</a>.</p>
</div>
<div class="paragraph">
<p>For step-by-step instructions on creating client certificates, see <a href="configure-client-certificates.html" class="xref page">Configure Client Certificates</a>.</p>
</div>
<div class="paragraph">
<p>For an example of using node and  <a href="configure-client-certificates.html" class="xref page">client certificates</a> to secure XDCR replication between clusters, see <a href="../manage-xdcr/enable-full-secure-replication.html#specify-full-xdcr-security-with-certificates" class="xref page">Specify Root and Client Certificates, and Client Private Key</a>.</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span>© 2024 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Server","components":["server"],"url":"/home/server.html","latestVersions":{"server":"7.6"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../../_/js/vendor/chatbox-ui.js"></script>
<script id="site-script" src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab"></script>
<script defer src="../../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
</body>
</html>
