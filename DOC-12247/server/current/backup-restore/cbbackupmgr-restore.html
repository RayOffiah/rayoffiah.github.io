<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://metrics.couchbase.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
<!-- End Google Tag Manager -->
<title>cbbackupmgr restore | Couchbase Docs</title>
<link rel="canonical" href="https://docs.couchbase.com/server/current/backup-restore/cbbackupmgr-restore.html">
<link rel="stylesheet" href="../../../_/css/site.css">
<script src="../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Restores data from the backup archive to a Couchbase cluster">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="7.6">
<meta name="page-url" content="/server/current/backup-restore/cbbackupmgr-restore.html">
<meta name="page-nav-header-levels" content="0">

<meta name="docsearch:component" content="server">
<meta name="docsearch:component_title" content="Couchbase Server">
<meta name="docsearch:cversion" content="7.6">
<meta name="docsearch:component_version" content="server@7.6">
<meta name="docsearch:module" content="backup-restore">
<meta name="docsearch:breadcrumbs" content="Couchbase Server / Reference / CLI Reference / cbbackupmgr / cbbackupmgr restore">
<meta name="docsearch:topic_type" content="">
<meta name="docsearch:version_rank" content="1">
<meta name="docsearch:status" content="">
<meta name="docsearch:edition" content="">
<meta name="docsearch:page_rank" content="50">


<meta name="generator" content="Antora 3.1.7">
<link rel="icon" href="../../../_/img/favicon.svg" type="image/svg+xml">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon" sizes="any">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation"
                      href="https://docs.couchbase.com/home/index.html">
                    <img src="../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">

                  <li class="nav-item "">
                    <a href="https://docs.couchbase.com/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item nav-item-selected">
                    <a class="nav-link" href="../../../home/server.html">
                      Server
                      
                    </a>
                  </li>
                  <li class="nav-item ">
                    <a class="nav-link" href="../../../home/mobile.html">
                      Mobile
                      
                    </a>
                  </li>
                  <li class="nav-item ">
                    <a class="nav-link" href="../../../cloud/index.html">
                      Capella
                      
                    </a>
                  </li>
                  <li class="nav-item ">
                    <a class="nav-link" href="../../../home/sdk.html">
                      SDKs
                      
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>
              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
    <template id="page-versions" style="display: none">
      <select class="version_list" data-component="server">
        <option value="7.6" data-url="cbbackupmgr-restore.html" selected>7.6</option>
        <option value="7.2" data-url="../../7.2/index.html">7.2</option>
        <option value="7.1" data-url="../../7.1/index.html">7.1</option>
        <option value="7.0" data-url="../../7.0/index.html">7.0</option>
      </select>
    </template>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/rayoffiah/projects/couchbase/backup/docs/modules/backup-restore/pages/cbbackupmgr-restore.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../introduction/intro.html">Couchbase Server</a></li>
<li class="crumb">Reference</li>
<li class="crumb"><a href="../cli/cli-intro.html">CLI Reference</a></li>
<li class="crumb"><a href="cbbackupmgr.html">cbbackupmgr</a></li>
<li class="crumb"><a href="cbbackupmgr-restore.html">cbbackupmgr restore</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">cbbackupmgr restore</h1>
<div class="labels">
<ul></ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Restores data from the backup archive to a Couchbase cluster</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="synopsis"><a class="anchor" href="#synopsis"></a>SYNOPSIS</h2>
<div class="sectionbody">
<div class="verseblock">
<pre class="content">cbbackupmgr restore [--archive &lt;archive_dir&gt;] [--repo &lt;repo_name&gt;]
                    [--cluster &lt;host&gt;] [--username &lt;username&gt;]
                    [--password &lt;password&gt;] [--client-cert &lt;path&gt;]
                    [--client-cert-password &lt;password&gt;] [--client-key &lt;path&gt;]
                    [--client-key-password &lt;password&gt;] [--start &lt;start&gt;]
                    [--end &lt;end&gt;] [--include-data &lt;collection_string_list&gt;]
                    [--exclude-data &lt;collection_string_list&gt;]
                    [--map-data &lt;collection_string_mappings&gt;]
                    [--disable-cluster-analytics] [--disable-analytics]
                    [--disable-views] [--disable-gsi-indexes]
                    [--disable-ft-indexes] [--disable-ft-alias]
                    [--disable-data] [--disable-eventing]
                    [--disable-bucket-query] [--disable-cluster-query]
                    [--enable-users] [--overwrite-users] [--capella]
                    [--replace-ttl &lt;type&gt;][--replace-ttl-with &lt;timestamp&gt;]
                    [--force-updates]
                    [--threads &lt;integer&gt;] [--vbucket-filter &lt;integer_list&gt;]
                    [--no-progress-bar] [--auto-create-buckets]
                    [--autoremove-collections] [--continue-on-cs-failure]
                    [--restore-partial-backups] [--obj-access-key-id &lt;access_key_id&gt;]
                    [--obj-cacert &lt;cert_path&gt;] [--obj-endpoint &lt;endpoint&gt;]
                    [--obj-read-only-mode] [--obj-no-ssl-verify]
                    [--obj-region &lt;region&gt;] [--obj-staging-dir &lt;staging_dir&gt;]
                    [--obj-secret-access-key &lt;secret_access_key&gt;]
                    [--s3-force-path-style] [--s3-log-level &lt;level&gt;]
                    [--point-in-time &lt;time&gt;]
                    [--filter-keys &lt;regexp&gt;] [--filter-values &lt;regexp&gt;]
                    [--passphrase &lt;passphrase&gt;] [--km-key-url &lt;url&gt;]
                    [--km-endpoint &lt;endpoint&gt;] [--km-region &lt;region&gt;]
                    [--km-access-key-id &lt;id&gt;] [--km-secret-access-key &lt;key&gt;]
                    [--km-auth-file &lt;path&gt;] [--purge] [--resume]</pre>
</div>
</div>
</div>
<div class="sect1">
<h2 id="description"><a class="anchor" href="#description"></a>DESCRIPTION</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Restores data from the backup archive to a target Couchbase cluster. By default
all data, index definitions, view definitions, full-text index definitions and
users are restored to the cluster unless specified otherwise in the repos backup
Restores data from the backup archive to a target Couchbase cluster.</p>
</div>
<div class="paragraph">
<p>The restore command is capable of restoring a single backup or a range of
backups. When restoring a single backup, all data from that backup is restored.
If a range of backups is restored, then cbbackupmgr will take into account
any failovers that may have occurred in between the time that the backups were
originally taken. If a failure does occur in between the backups, and the backup
archive contains data that no longer exists in the cluster, then the data that
no longer exists will be skipped during the restore. If no failovers occurred in
between backups, then restoring a range of backups will restore all data from
each backup. If all data must be restored, regardless of whether a failover
occurred in between the original backups, then data should be restored one
backup at a time.</p>
</div>
<div class="paragraph">
<p>The restore command is guaranteed to work during rebalances and failovers. If a
rebalance is taking place, cbbackupmgr will track the movement of vbuckets
around a Couchbase cluster and ensure that data is restored to the appropriate
node. If a failover occurs during the restore, then the client will wait 180
seconds for the failed node to be removed from the cluster. If the failed node
is not removed in 180 seconds then the restore will fail, but if the failed node
is removed before the timeout then data will continue to be restored.</p>
</div>
<div class="paragraph">
<p>Note that if you are restoring indexes, then it is highly likely that you will
need to take some manual steps to properly restore them.
This is
because by default, indexes will only be built if they are restored to the exact
same index node that they were backed up from.
If the index node they were
backed up from does not exist, then the indexes will be restored in round-robin
fashion among the current indexer nodes.
These indexes will be created, but not
built and will require the administrator to manually build them.
We do this
because we cannot know the optimal index topology ahead of time.
By not building
the indexes, the administrator can move each index between nodes and build them
when they deem that the index topology is optimal.</p>
</div>
<div class="paragraph">
<p>If restoring a backup from a cluster running version 7.2 or below to a cluster
running version 7.6 or above, because of the <code>_system</code> scope present in 7.6 and
above, you may need to map one of your scopes or collections where you did not
have to before. This would only happen if the cluster you are restoring to has
bucket scopes or collections with the same name as the scopes or collections in
your backup. In that case the scopes or collections, while they do have the same
name, might have different IDs and you would receive this error: <code>Error
restoring cluster: scope 'testScope' with id 0x8 exists with a different name/id
on the cluster, a manual remap using '--map-data' is required</code>. To avoid this
you would need to tell cbbackupmgr to ignore the scope IDs and restore the scope
in your backup to the scope in your cluster using the <code>--map-data</code> flag
e.g. <code>--map-data bucket.testScope=bucket.testScope</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="options"><a class="anchor" href="#options"></a>OPTIONS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Below is a list of required and optional parameters for the restore command.</p>
</div>
<div class="sect2">
<h3 id="required"><a class="anchor" href="#required"></a>Required</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">-a,--archive &lt;archive_dir&gt;</dt>
<dd>
<p>The directory containing the backup repository to restore data from. When
restoring from an archive stored in S3 prefix the archive path with
<code>s3://${BUCKET_NAME}/</code>.</p>
</dd>
<dt class="hdlist1">-r,--repo &lt;repo_name&gt;</dt>
<dd>
<p>The name of the backup repository to restore data from.</p>
</dd>
<dt class="hdlist1">-c,--cluster &lt;hostname&gt;</dt>
<dd>
<p>The hostname of one of the nodes in the cluster to restore data to. See the
<a href="#HOST_FORMATS">HOST FORMATS</a> section below for hostname specification details.</p>
</dd>
<dt class="hdlist1">-u,--username &lt;username&gt;</dt>
<dd>
<p>The username for cluster authentication. The user must have the appropriate
privileges to take a backup.</p>
</dd>
<dt class="hdlist1">-p,--password &lt;password&gt;</dt>
<dd>
<p>The password for cluster authentication. The user must have the appropriate
privileges to take a backup. If not password is supplied to this option then
you will be prompted to enter your password.</p>
</dd>
<dt class="hdlist1">--client-cert &lt;path&gt;</dt>
<dd>
<p>The path to a client certificate used to authenticate when connecting to a
cluster. May be supplied with <code>--client-key</code> as an alternative to the
<code>--username</code> and <code>--password</code> flags.  See the <a href="#CERTIFICATE_AUTHENTICATION">CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</a>
section for more information.</p>
</dd>
<dt class="hdlist1">--client-cert-password &lt;password&gt;</dt>
<dd>
<p>The password for the certificate provided to the <code>--client-cert</code> flag, when
using this flag, the certificate/key pair is expected to be in the PKCS#12
format. See the <a href="#CERTIFICATE_AUTHENTICATION">CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</a> section for more information.</p>
</dd>
<dt class="hdlist1">--client-key &lt;path&gt;</dt>
<dd>
<p>The path to the client private key whose public key is contained in the
certificate provided to the <code>--client-cert</code> flag. May be supplied with
<code>--client-cert</code> as an alternative to the <code>--username</code> and <code>--password</code>
flags. See the <a href="#CERTIFICATE_AUTHENTICATION">CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</a> section for more information.</p>
</dd>
<dt class="hdlist1">--client-key-password &lt;password&gt;</dt>
<dd>
<p>The password for the key provided to the <code>--client-key</code> flag, when using this
flag, the key is expected to be in the PKCS#8 format.
See the <a href="#CERTIFICATE_AUTHENTICATION">CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</a> section for more information.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="optional"><a class="anchor" href="#optional"></a>Optional</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">--start &lt;start&gt;</dt>
<dd>
<p>The first backup to restore. See <a href="#START_AND_END">START AND END</a> for information on what values
are accepted.</p>
</dd>
<dt class="hdlist1">--end &lt;end&gt;</dt>
<dd>
<p>The final backup to restore. See <a href="#START_AND_END">START AND END</a> for information on what values
are accepted.</p>
</dd>
<dt class="hdlist1">--include-data &lt;collection_string_list&gt;</dt>
<dd>
<p>Overrides the repository configuration to restore only the data specified in
the &lt;collection_string_list&gt;. This flag takes a comma-separated list of
collection strings and can&#8217;t be specified at the same time as
<code>--exclude-data</code>. Note that including data at the scope/collection level is
an Enterprise Edition feature.</p>
</dd>
<dt class="hdlist1">--exclude-data &lt;collection_string_list&gt;</dt>
<dd>
<p>Overrides the repository configuration to skip restoring the data specified
in the &lt;collection_string_list&gt;. This flag takes a comma-separated list of
collection strings and can&#8217;t be specified at the same time as
<code>--include-data</code>. Note that excluding data at the scope/collection level is
an Enterprise Edition feature.</p>
</dd>
<dt class="hdlist1">--filter-keys</dt>
<dd>
<p>Only restore data where the key matches a particular regular expression.
The regular expressions provided must follow
<a href="https://github.com/google/re2/wiki/Syntax">RE2 syntax</a>.</p>
</dd>
<dt class="hdlist1">--filter-values</dt>
<dd>
<p>Only restore data where the value matches a particular regular expression.
The regular expressions provided must follow
<a href="https://github.com/google/re2/wiki/Syntax">RE2 syntax</a>.</p>
</dd>
<dt class="hdlist1">--enable-bucket-config</dt>
<dd>
<p>Enables restoring the bucket configuration.</p>
</dd>
<dt class="hdlist1">--disable-views</dt>
<dd>
<p>Skips restoring view definitions for all buckets.</p>
</dd>
<dt class="hdlist1">--disable-gsi-indexes</dt>
<dd>
<p>Skips restoring gsi index definitions for all buckets.</p>
</dd>
<dt class="hdlist1">--disable-ft-indexes</dt>
<dd>
<p>Skips restoring full-text index definitions for all buckets.</p>
</dd>
<dt class="hdlist1">--disable-ft-alias</dt>
<dd>
<p>Skips restoring full-text alias definitions.</p>
</dd>
<dt class="hdlist1">--disable-data</dt>
<dd>
<p>Skips restoring all key-value data for all buckets, but scopes and collections
are created.</p>
</dd>
<dt class="hdlist1">--disable-cluster-analytics</dt>
<dd>
<p>Skips restoring analytics cluster level analytics metadata e.g. Synonyms.</p>
</dd>
<dt class="hdlist1">--disable-analytics</dt>
<dd>
<p>Skips restoring bucket level analytics metadata.</p>
</dd>
<dt class="hdlist1">--disable-eventing</dt>
<dd>
<p>Skips restoring the eventing service metadata.</p>
</dd>
<dt class="hdlist1">--disable-bucket-query</dt>
<dd>
<p>Skips restoring bucket level Query Service metadata.</p>
</dd>
<dt class="hdlist1">--disable-cluster-query</dt>
<dd>
<p>Skips restoring cluster level Query Service metadata.</p>
</dd>
<dt class="hdlist1">--enable-users</dt>
<dd>
<p>Enables restoring cluster level users. As backup/restore of users is only
available for CB version 7.6 and upwards, the flag is ignored for previous
versions. To work you will need the correct permissions
(cluster.admin.security).</p>
</dd>
<dt class="hdlist1">--overwrite-users</dt>
<dd>
<p>Overwrites the already existing users in the cluster as the default behavior of
backup/restore of users is to skip already existing users, this flag can be
used to overwrite this behavior. As backup/restore of users is only available
for CB version 7.6 and upwards, the flag is ignored for previous versions.</p>
</dd>
<dt class="hdlist1">--capella</dt>
<dd>
<p>Skips restoring services that are not supported with Capella including: analytics,
cluster analytics, bucket query, cluster query, views and users. This flag
can be used to enable restoring from an on-premise cluster to a Capella one.</p>
</dd>
<dt class="hdlist1">--force-updates</dt>
<dd>
<p>Forces data in the Couchbase cluster to be overwritten even if the data in
the cluster is newer. By default, updates are not forced, and all updates use
Couchbase&#8217;s conflict resolution mechanism to ensure that if newer data
exists on the cluster that is not overwritten by older restore data.</p>
</dd>
<dt class="hdlist1">--map-data &lt;collection_string_mappings&gt;</dt>
<dd>
<p>Specified when you want to restore source data into a different location. For
example this argument may be used to remap buckets/scopes/collections with
the restriction that they must be remapped at the same level. For example a
bucket may only be remapped to a bucket, a scope to a scope and a collection
to a collection. The argument expects a comma-separated list of collection
string mappings e.g.
<code>bucket1=bucket2,bucket3.scope1=bucket3.scope2,bucket4.scope.collection1=bucket4.scope.collection2</code>
If used to remap a bucket into a collection then it will only restore data
for the data service and will skip data for all the other services.
See <a href="#REMAPPING">REMAPPING</a> for additional information about this option.</p>
</dd>
<dt class="hdlist1">--replace-ttl &lt;type&gt;</dt>
<dd>
<p>Sets a new expiration (time-to-live) value for the specified keys. This
parameter can either be set to "none", "all" or "expired" and should be used
along with the --replace-ttl-with flag. If "none" is supplied then the TTL
values are not changed. If "all" is specified then the TTL values for all
keys are replaced with the value of the --replace-ttl-with flag.  If
"expired" is set then only keys which have already expired will have the
TTL&#8217;s replaced. For more information about the behavior of <code>--replace-ttl</code>
see the <a href="#REPLACE_TTL">REPLACE TTL</a>.</p>
</dd>
<dt class="hdlist1">--replace-ttl-with &lt;timestamp&gt;</dt>
<dd>
<p>Updates the expiration for the keys specified by the --replace-ttl parameter.
The parameter has to be set when --replace-ttl is set to "all". There are two
options, RFC3339 time stamp format (2006-01-02T15:04:05-07:00) or "0". When
"0" is specified the expiration will be removed. Please note that the RFC3339
value is converted to a Unix time stamp on the cbbackupmgr client. It is
important that the time on both the client and the Couchbase Server are the
same to ensure expiry happens correctly. For more information about the
behavior of <code>--replace-ttl-with</code> see the <a href="#REPLACE_TTL">REPLACE TTL</a>.</p>
</dd>
<dt class="hdlist1">--vbucket-filter &lt;list&gt;</dt>
<dd>
<p>Specifies a list of VBuckets that should be restored. VBuckets are specified
as a comma separated list of integers. If this parameter is not set then all
vBuckets which were backed up are restored.</p>
</dd>
<dt class="hdlist1">--no-ssl-verify</dt>
<dd>
<p>Skips the SSL verification phase. Specifying this flag will allow a
connection using SSL encryption, but will not verify the identity of the
server you connect to. You are vulnerable to a man-in-the-middle attack if
you use this flag. Either this flag or the --cacert flag must be specified
when using an SSL encrypted connection.</p>
</dd>
<dt class="hdlist1">--cacert &lt;cert_path&gt;</dt>
<dd>
<p>Specifies a CA certificate that will be used to verify the identity of the
server being connecting to. Either this flag or the --no-ssl-verify flag
must be specified when using an SSL encrypted connection.</p>
</dd>
<dt class="hdlist1">-t,--threads &lt;num&gt;</dt>
<dd>
<p>Specifies the number of concurrent clients to use when restoring data. Fewer
clients means restores will take longer, but there will be less cluster
resources used to complete the restore. More clients means faster restores,
but at the cost of more cluster resource usage. This parameter defaults to 1
if it is not specified and it is recommended that this parameter is not set
to be higher than the number of CPUs on the machine where the restore is
taking place.</p>
</dd>
<dt class="hdlist1">--no-progress-bar</dt>
<dd>
<p>By default, a progress bar is printed to stdout so that the user can see how
long the restore is expected to take, the amount of data that is being
transferred per second, and the amount of data that has been restored.
Specifying this flag disables the progress bar and is useful when running
automated jobs.</p>
</dd>
<dt class="hdlist1">--auto-create-buckets</dt>
<dd>
<p>It will create the destination buckets if not present in the server.</p>
</dd>
<dt class="hdlist1">--autoremove-collections</dt>
<dd>
<p>Automatically delete scopes/collections which are known to be deleted in the
backup. See <a href="#SCOPE_COLLECTION_DELETION">[SCOPE_COLLECTION_DELETION]</a> for more details.</p>
</dd>
<dt class="hdlist1">--continue-on-cs-failure</dt>
<dd>
<p>It&#8217;s possible that during a restore, a checksum validation will fail; in this
case the restore will fail fast. Supplying this flag will mean that the restore
will attempt to continue upon receiving a checksum failure. See <a href="#CHECKSUM_FAILURE">CHECKSUM FAILURE</a>
for more information.</p>
</dd>
<dt class="hdlist1">--restore-partial-backups</dt>
<dd>
<p>Allow a restore to continue when the final backup in the restore range is
incomplete. This flag is incompatible with the <code>--obj-read-only</code> flag.</p>
</dd>
<dt class="hdlist1">--point-in-time &lt;time&gt;</dt>
<dd>
<p>(Beta) Specifies the point in time to restore to. The value accepted is ISO8601 date
time format (YYYY-MM-DDTHH:MM:SS). This feature is currently in Beta and is not
supported, this should only be used in test environments.</p>
</dd>
<dt class="hdlist1">--purge</dt>
<dd>
<p>If the last restore failed before it finished, then remove it&#8217;s progress
(which is persisted to disk) then restart from zero. Note that only the
restore progress is purge, no backup data will be removed.</p>
</dd>
<dt class="hdlist1">--resume</dt>
<dd>
<p>If the last restore failed before it finished, then try to continue from
where it left off.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="cloud-integration"><a class="anchor" href="#cloud-integration"></a>Cloud integration</h3>
<div class="paragraph">
<p>Native cloud integration is an Enterprise Edition feature which was introduced
in Couchbase Server 6.6.0.</p>
</div>
<div class="paragraph">
<p>Multiple cloud providers are supported, see the list below for more information.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Supported</p>
<div class="ulist">
<ul>
<li>
<p>AWS S3 (<code>s3://</code>)</p>
</li>
<li>
<p>GCP Google Storage (<code>gs://</code>)</p>
</li>
<li>
<p>Azure Blob Storage in 7.1.2+ (<code>az://</code>)</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="required-2"><a class="anchor" href="#required-2"></a>Required</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">--obj-staging-dir &lt;staging_dir&gt;</dt>
<dd>
<p>When performing an operation on an archive which is located in the cloud such
as AWS, the staging directory is used to store local meta data files. This
directory can be temporary (it&#8217;s not treated as a persistent store) and is
only used during the backup. NOTE: Do not use <code>/tmp</code> as the <code>obj-staging-dir</code>.
See <code>Disk requirements</code> in <a href="cbbackupmgr-cloud.html" class="xref page">cbbackupmgr-cloud</a> for more information.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="optional-2"><a class="anchor" href="#optional-2"></a>Optional</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">--obj-access-key-id &lt;access_key_id&gt;</dt>
<dd>
<p>The access key id which has access to your chosen object store. This option
can be omitted when using the shared config functionality provided by your
chosen object store. Can alternatively be provided using the
<code>CB_OBJSTORE_ACCESS_KEY_ID</code> environment variable.</p>
<div class="paragraph">
<p>When using AWS, this option expects an access key id. See
<a href="https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#access-keys-and-secret-access-keys" class="bare">https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#access-keys-and-secret-access-keys</a>
for more information.</p>
</div>
<div class="paragraph">
<p>When using Azure, this option expects an account name. See
<a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-account-overview#storage-account-endpoints" class="bare">https://docs.microsoft.com/en-us/azure/storage/common/storage-account-overview#storage-account-endpoints</a>
for more information.</p>
</div>
<div class="paragraph">
<p>When using GCP, this option expects a client id. See
<a href="https://cloud.google.com/storage/docs/authentication" class="bare">https://cloud.google.com/storage/docs/authentication</a> for more information.</p>
</div>
</dd>
<dt class="hdlist1">--obj-cacert &lt;cert_path&gt;</dt>
<dd>
<p>Specifies a CA certificate that will be used to verify the identity of the
object store being connected to.</p>
</dd>
<dt class="hdlist1">--obj-endpoint &lt;endpoint&gt;</dt>
<dd>
<p>The host/address of your object store.</p>
</dd>
<dt class="hdlist1">--obj-read-only</dt>
<dd>
<p>Enable read only mode. When interacting with a cloud archive modifications
will be made e.g. a lockfile will be created, log rotation will take place
and the modified logs will be uploaded upon completion of the subcommand.
This flag disables these features should you wish to interact with an archive
in a container where you lack write permissions. This flag should be used
with caution and you should be aware that your logs will not be uploaded to
the cloud. This means that it&#8217;s important that if you encounter an error you
don&#8217;t remove you staging directory (since logs will still be created in there
and collected by the <code>collect-logs</code> subcommand).</p>
</dd>
<dt class="hdlist1">--obj-no-ssl-verify</dt>
<dd>
<p>Skips the SSL verification phase when connecting to the object store.
Specifying this flag will allow a connection using SSL encryption, but you
are vulnerable to a man-in-the-middle attack.</p>
</dd>
<dt class="hdlist1">--obj-region &lt;region&gt;</dt>
<dd>
<p>The region in which your bucket/container resides. For AWS this option may be
omitted when using the shared config functionality. See the AWS section of
the cloud documentation for more information.</p>
</dd>
<dt class="hdlist1">--obj-secret-access-key &lt;secret_access_key&gt;</dt>
<dd>
<p>The secret access key which has access to you chosen object store. This
option can be omitted when using the shared config functionality provided by
your chosen object store. Can alternatively be provided using the
<code>CB_OBJSTORE_SECRET_ACCESS_KEY</code> environment variable.</p>
<div class="paragraph">
<p>When using AWS, this option expects a secret access key. See
<a href="https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#access-keys-and-secret-access-keys" class="bare">https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#access-keys-and-secret-access-keys</a>
for more information.</p>
</div>
<div class="paragraph">
<p>When using Azure, this option expects an account key. See
<a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-account-keys-manage?tabs=azure-portal" class="bare">https://docs.microsoft.com/en-us/azure/storage/common/storage-account-keys-manage?tabs=azure-portal</a>
for more information.</p>
</div>
<div class="paragraph">
<p>When using GCP, this option expects a client secret. See
<a href="https://cloud.google.com/storage/docs/authentication" class="bare">https://cloud.google.com/storage/docs/authentication</a> for more information.</p>
</div>
</dd>
<dt class="hdlist1">--obj-log-level &lt;level&gt;</dt>
<dd>
<p>Set the log level for the cloud providers SDK. By default logging will be
disabled. Valid options are cloud provider specific and are listed below.</p>
<div class="paragraph">
<p>The valid options for the AWS SDK are <code>debug</code>, <code>debug-with-signing</code>,
<code>debug-with-body</code>, <code>debug-with-request-retries</code>, <code>debug-with-request-errors</code>,
and <code>debug-with-event-stream-body</code>.</p>
</div>
<div class="paragraph">
<p>The valid options for the Azure SDK are <code>info</code>, <code>debug</code>, <code>debug-with-request-retries</code> and
<code>debug-with-request-retries-and-lro</code>.</p>
</div>
<div class="paragraph">
<p>The Google Storage SDK does not expose advanced logging configuration meaning
this option is explicitly ignored, however, this behavior may change in the
future.</p>
</div>
</dd>
<dt class="hdlist1">--obj-auth-by-instance-metadata</dt>
<dd>
<p>Depending on the cloud provider, using instance metadata for authentication
is disabled by default. Supplying this flag will allow the fetching
credentials/auth tokens from (VM) internal instance metadata endpoints.</p>
<div class="paragraph">
<p>By default, this option is disabled for AWS.</p>
</div>
<div class="paragraph">
<p>By default, this option is enabled for Azure.</p>
</div>
<div class="paragraph">
<p>By default, this option is enabled for GCP.</p>
</div>
</dd>
<dt class="hdlist1">--obj-auth-file</dt>
<dd>
<p>GCP offers the ability to use a file which contains credentials which will be
used to perform authentication. The <code>--obj-auth-file</code> flag accepts a path to
an authentication file. This flag is unsupported for the AWS/Azure cloud
providers.</p>
</dd>
<dt class="hdlist1">--obj-refresh-token</dt>
<dd>
<p>GCP requires a refresh token when using static credentials, this will be used
to refresh oauth2 tokens when accessing remote storage.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="aws-s3-options"><a class="anchor" href="#aws-s3-options"></a>AWS S3 Options</h4>
<div class="sect4">
<h5 id="optional-3"><a class="anchor" href="#optional-3"></a>Optional</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">--s3-force-path-style</dt>
<dd>
<p>By default the updated virtual style paths will be used when interfacing with
AWS S3. This option will force the AWS SDK to use the alternative path style
URLs which are often required by S3 compatible object stores.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="encryption-developer-preview"><a class="anchor" href="#encryption-developer-preview"></a>Encryption (Developer Preview)</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">--passphrase &lt;passphrase&gt;</dt>
<dd>
<p>Passphrase can be used instead of an external key manager. This is not
supported on production and should only be used in development or testing.</p>
</dd>
<dt class="hdlist1">--km-key-url &lt;url&gt;</dt>
<dd>
<p>Provides the Key Identifier in the external Key Management system. Currently
supported KMSs are AWS KMS, GCP KMS, Azure KeyVault, HashiCorp Vault Transit
secrets engine. The option can also be provided using the environmental
variable <code>CB_KM_KEY_URL</code>. For more on how to authenticate using the different
providers see <a href="cbbackupmgr-encryption.html" class="xref page">cbbackupmgr-encryption</a>.</p>
<div class="paragraph">
<p>For AWS the expected key format is <code>awskms://&lt;KEY-ID|KEY-ALIAS&gt;</code>, for example
<code>awskms://alias/keyAlias</code>.</p>
</div>
<div class="paragraph">
<p>For GCP the expected key format is <code>gcpkms://&lt;KEY-RESOURCE-ID&gt;</code>, for example
<code>gcpkms://projects/project-id/locations/location/keyRings/keyring/cryptoKeys/key</code>.</p>
</div>
<div class="paragraph">
<p>For Azure key vault the expected key format is <code>azurekeyvault://&lt;KEY-IDENTIFIER&gt;</code>
for example:
<code>azurekeyvault://vault-name.vault.azure.net/object-type/object-name/object-version</code>.</p>
</div>
<div class="paragraph">
<p>For HashiCorp Vault the expected format is <code>hashivaults://&lt;HOST&gt;/&lt;KEY-NAME&gt;</code>
for example:
<code>hashivaults://127.0.0.1:8200/keyName</code>.</p>
</div>
</dd>
<dt class="hdlist1">--km-region &lt;region&gt;</dt>
<dd>
<p>Required when using AWS KMS, it allows you to set the key region.</p>
</dd>
<dt class="hdlist1">--km-endpoint &lt;endpoint&gt;</dt>
<dd>
<p>The host or address to use as your KMS. It will override the default SDK one.</p>
</dd>
<dt class="hdlist1">--km-access-key-id &lt;id&gt;</dt>
<dd>
<p>The user ID used to connect to the key management service. It can also be
provided via <code>CB_KM_ACCESS_KEY_ID</code> environmental variable. Please refer
to <a href="cbbackupmgr-encryption.html" class="xref page">cbbackupmgr-encryption</a> for the required authentication for each
provider.</p>
</dd>
<dt class="hdlist1">--km-secret-access-key &lt;key&gt;</dt>
<dd>
<p>The key used to connect to the key management service. It can also be
provided via the <code>CB_KM_SECRET_ACCESS_KEY</code> environmental variable. Please
refer to <a href="cbbackupmgr-encryption.html" class="xref page">cbbackupmgr-encryption</a> for the required authentication for
each provider.</p>
</dd>
<dt class="hdlist1">--km-tenant-id &lt;id&gt;</dt>
<dd>
<p>The tenant ID used to connect to the key management service. It can also be
provided via the <code>CB_KM_TENANT_ID</code> environmental variable. This argument is
only required when doing access key authentication with Azure. Please refer
to <a href="cbbackupmgr-encryption.html" class="xref page">cbbackupmgr-encryption</a> for the required authentication for each
provider.</p>
</dd>
<dt class="hdlist1">--km-auth-file &lt;path&gt;</dt>
<dd>
<p>The path to a file containing the authentication credentials for the key
management service. It can also be provided via the <code>CB_KM_AUTH_FILE</code>
environmental variable. Please refer to <a href="cbbackupmgr-encryption.html" class="xref page">cbbackupmgr-encryption</a> for the
required authentication for each provider.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="START_AND_END"><a class="anchor" href="#START_AND_END"></a>START AND END</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This sub-command accepts a <code>--start</code> and <code>--end</code> flag. These flags accept
multiple values to allow you to flexibly operate on a range of backups.</p>
</div>
<div class="sect2">
<h3 id="indexes"><a class="anchor" href="#indexes"></a>Indexes</h3>
<div class="paragraph">
<p>Indexes may be supplied to operate on a range of backups, for example
<code>--start 1 --end 2</code> will include start at the first backup and will finish with
the second backup. Note that the first backup is 1 and not 0 and that the
<code>--end</code> flag is inclusive.</p>
</div>
</div>
<div class="sect2">
<h3 id="short-dates"><a class="anchor" href="#short-dates"></a>Short Dates</h3>
<div class="paragraph">
<p>Short dates may be supplied in the format <code>day-month-year</code>. For example
<code>--start 01-08-2020 --end 31-08-2020</code> will operate on all the backups which
were taken during August of 2020. Note that the end date is inclusive.</p>
</div>
<div class="paragraph">
<p>When supplying short dates, you may supply <code>start</code> or <code>oldest</code> as a placeholder
for the date on which the first backup in this repository was taken. The
keywords <code>end</code> or <code>latest</code> may be used as a placeholder for the date last
backup in the repository was taken.</p>
</div>
</div>
<div class="sect2">
<h3 id="backup-names"><a class="anchor" href="#backup-names"></a>Backup Names</h3>
<div class="paragraph">
<p>Backup names may be supplied as they exist on disk. For example
<code>--start 2020-08-13T20_01_08.894226137+01_00 --end 2020-08-13T20_01_12.348300092+01_00</code>
will cause the sub-command to operate on all the backups which inclusively fall
between these two backups.</p>
</div>
<div class="paragraph">
<p>When supplying backup names, you may supply <code>start</code> or <code>oldest</code> as a
placeholder for the first backup in the repository. The keywords <code>end</code> or
<code>latest</code> may be used  as a placeholder for the final backup in the repository.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="HOST_FORMATS"><a class="anchor" href="#HOST_FORMATS"></a>HOST FORMATS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When specifying a host/cluster for a command using the <code>-c</code>/<code>--cluster</code> flag, the following formats
are accepted:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;addr&gt;:&lt;port&gt;</code></p>
</li>
<li>
<p><code>http://&lt;addr&gt;:&lt;port&gt;</code></p>
</li>
<li>
<p><code>https://&lt;addr&gt;:&lt;port&gt;</code></p>
</li>
<li>
<p><code>couchbase://&lt;addr&gt;:&lt;port&gt;</code></p>
</li>
<li>
<p><code>couchbases://&lt;addr&gt;:&lt;port&gt;</code></p>
</li>
<li>
<p><code>couchbase://&lt;srv&gt;</code></p>
</li>
<li>
<p><code>couchbases://&lt;srv&gt;</code></p>
</li>
<li>
<p><code>&lt;addr&gt;:&lt;port&gt;,&lt;addr&gt;:&lt;port&gt;</code></p>
</li>
<li>
<p><code>&lt;scheme&gt;://&lt;addr&gt;:&lt;port&gt;,&lt;addr&gt;:&lt;port&gt;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>&lt;port&gt;</code> portion of the host format may be omitted, in which case the default port will be used
for the scheme provided. For example, <code>http://</code> and <code>couchbase://</code> will both default to 8091 where
<code>https://</code> and <code>couchbases://</code> will default to 18091. When connecting to a host/cluster using a
non-default port, the <code>&lt;port&gt;</code> portion of the host format must be specified.</p>
</div>
<div class="sect2">
<h3 id="connection-strings-multiple-nodes"><a class="anchor" href="#connection-strings-multiple-nodes"></a>Connection Strings (Multiple nodes)</h3>
<div class="paragraph">
<p>The <code>-c</code>/<code>--cluster</code> flag accepts multiple nodes in the format of a connection string; this is a
comma separated list of <code>&lt;addr&gt;:&lt;port&gt;</code> strings where <code>&lt;scheme&gt;</code> only needs to be specified once.
The main advantage of supplying multiple hosts is that in the event of a failure, the next host in
the list will be used.</p>
</div>
<div class="paragraph">
<p>For example, all of the following are valid connection strings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>localhost,[::1]</code></p>
</li>
<li>
<p><code>10.0.0.1,10.0.0.2</code></p>
</li>
<li>
<p><code>http://10.0.0.1,10.0.0.2</code></p>
</li>
<li>
<p><code>https://10.0.0.1:12345,10.0.0.2</code></p>
</li>
<li>
<p><code>couchbase://10.0.0.1,10.0.0.2</code></p>
</li>
<li>
<p><code>couchbases://10.0.0.1:12345,10.0.0.2:12345</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="srv-records"><a class="anchor" href="#srv-records"></a>SRV Records</h3>
<div class="paragraph">
<p>The <code>-c</code>/<code>--cluster</code> flag accepts DNS SRV records in place of a host/cluster address where the SRV
record will be resolved into a valid connection string. There are a couple of rules which must be
followed when supplying an SRV record which are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>&lt;scheme&gt;</code> portion must be either <code>couchbase://</code> or <code>couchbases://</code></p>
</li>
<li>
<p>The <code>&lt;srv&gt;</code> portion should be a hostname with no port</p>
</li>
<li>
<p>The <code>&lt;srv&gt;</code> portion must not be a valid IP address</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, all of the following are valid connection string using an SRV record:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>couchbase://hostname</code></p>
</li>
<li>
<p><code>couchbases://hostname</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="alternate-addressing-caok8s"><a class="anchor" href="#alternate-addressing-caok8s"></a>Alternate Addressing (CAO/K8S)</h3>
<div class="paragraph">
<p>Users of the CAO (Couchbase Autonomous Operator) or K8S may need to supply the
<code>network=external</code> query parameter to force connection via the defined
alternate addressing.</p>
</div>
<div class="paragraph">
<p>For example, the following are valid connection strings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>https://10.0.0.1:12345,10.0.0.2?network=default</code></p>
</li>
<li>
<p><code>https://10.0.0.1:12345,10.0.0.2?network=external</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CERTIFICATE_AUTHENTICATION"><a class="anchor" href="#CERTIFICATE_AUTHENTICATION"></a>CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This tool supports authenticating against a Couchbase Cluster by using certificate based authentication (mTLS
authentication). To use certificate based authentication a certificate/key must be supplied, there a currently
multiple ways this may be done.</p>
</div>
<div class="sect2">
<h3 id="pem-encoded-certificatekey"><a class="anchor" href="#pem-encoded-certificatekey"></a>PEM ENCODED CERTIFICATE/KEY</h3>
<div class="paragraph">
<p>An unencrypted PEM encoded certificate/key may be supplied by using:
- <code>--client-cert &lt;path&gt;</code>
- <code>--client-key &lt;path&gt;</code></p>
</div>
<div class="paragraph">
<p>The file passed to <code>--client-cert</code> must contain the client certificate, and an optional chain required to authenticate
the client certificate.</p>
</div>
<div class="paragraph">
<p>The file passed to <code>--client-key</code> must contain at most one private key, the key can be in one of the following formats:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>PKCS#1</p>
</li>
<li>
<p>PKCS#8</p>
</li>
<li>
<p>EC</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Currently, only the following key types are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RSA</p>
</li>
<li>
<p>ECDSA</p>
</li>
<li>
<p>ED25519</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="pem-encoded-certificatepem-or-der-encrypted-pkcs8-key"><a class="anchor" href="#pem-encoded-certificatepem-or-der-encrypted-pkcs8-key"></a>PEM ENCODED CERTIFICATE/PEM OR DER ENCRYPTED PKCS#8 KEY</h3>
<div class="paragraph">
<p>An encrypted PKCS#8 formatted key may be provided using:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--client-cert &lt;path&gt;</code></p>
</li>
<li>
<p><code>--client-key &lt;path&gt;</code></p>
</li>
<li>
<p><code>--client-key-password &lt;password&gt;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The file passed to <code>--client-cert</code> must contain the client certificate, and an optional chain required to authenticate
the client certificate.</p>
</div>
<div class="paragraph">
<p>Currently, only the following key types are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RSA</p>
</li>
<li>
<p>ECDSA</p>
</li>
<li>
<p>ED25519</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="encrypted-pkcs12-certificatekey"><a class="anchor" href="#encrypted-pkcs12-certificatekey"></a>ENCRYPTED PKCS#12 CERTIFICATE/KEY</h3>
<div class="paragraph">
<p>An encrypted PKCS#12 certificate/key may be provided using:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--client-cert &lt;path&gt;</code></p>
</li>
<li>
<p><code>--client-cert-password &lt;password&gt;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The file passed to <code>--client-cert</code> must contain the client certificate and exactly one private key. It may also contain
the chain required to authenticate the client certificate.</p>
</div>
<div class="paragraph">
<p>Currently, only the following key types are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RSA</p>
</li>
<li>
<p>ECDSA</p>
</li>
<li>
<p>ED25519</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rbac"><a class="anchor" href="#rbac"></a>RBAC</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When performing a backup/restore with a user which is using RBAC, there are a
couple of things that should be taken into consideration each of which is
highlighted in this section.</p>
</div>
<div class="sect2">
<h3 id="bucket-level"><a class="anchor" href="#bucket-level"></a>Bucket Level</h3>
<div class="paragraph">
<p>Bucket level data may be backed up/restored using the <code>data_backup</code> (Data
Backup &amp; Restore) role.</p>
</div>
<div class="paragraph">
<p>The <code>data_backup</code> role does not have access to cluster level data such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Analytics Synonyms</p>
</li>
<li>
<p>Eventing Metadata</p>
</li>
<li>
<p>FTS Aliases</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Backing up/restoring cluster level data with the <code>data_backup</code> role will cause
permission errors like the one below.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Error backing up cluster: {"message":"Forbidden. User needs one of the following permissions","permissions":["cluster.fts!read"]}</pre>
</div>
</div>
<div class="paragraph">
<p>When presented with an error message such as the one above, there&#8217;s two clear
options.</p>
</div>
<div class="paragraph">
<p>The first option is to provide the user with the required credentials using
either the cli, REST API or Couchbase Server WebUI. This can be done by editing
the user and adding the required role. See <code>Cluster Level</code> for more information
about the required roles.</p>
</div>
<div class="paragraph">
<p>Secondly, backing up/restoring the specific service can be disabled. For
backups this must be done when configuring the repository with the <code>config</code>
command using the <code>--disable</code> style flags. For restore, these flags may be used
directly to disable one or more services. See the backup/restore documentation
for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="cluster-level"><a class="anchor" href="#cluster-level"></a>Cluster Level</h3>
<div class="paragraph">
<p>Backing up/restoring cluster level data requires additional RBAC roles, each of
which is highlighted below:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Analytics Synonyms</dt>
<dd>
<p><code>analytics_admin</code> (Analytics Admin)</p>
</dd>
<dt class="hdlist1">Eventing Metadata</dt>
<dd>
<p><code>eventing_admin</code> (Eventing Full Admin)</p>
</dd>
<dt class="hdlist1">FTS Aliases</dt>
<dd>
<p><code>fts_admin</code> (Search Admin)</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>These additional roles are required since this is cluster level data which may
encompass multiple buckets.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="supported-backup-versions"><a class="anchor" href="#supported-backup-versions"></a>Supported Backup Versions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>restore</code> sub-command currently supports restoring backups created by
previous versions of <code>cbbackupmgr</code> above and including 6.5.0. Versions before
6.5.0 used the <code>ForestDB</code> storage format which is no longer supported.</p>
</div>
<div class="paragraph">
<p>Backups created by these versions are still safe and usable, however, they must
be restored/merged with a version of <code>cbbackupmgr</code> which supports interacting
with 6.0.x archives e.g. 6.5.x, 6.6.x, 7.0.x and 7.1.x.</p>
</div>
<div class="sect2">
<h3 id="example"><a class="anchor" href="#example"></a>Example</h3>
<div class="paragraph">
<p>Imagine you have a backup created by a 6.0.x version of <code>cbbackupmgr</code>, this
will use the <code>ForestDB</code> storage format. You&#8217;d like to restore this backup,
however, the latest version no longer supports interacting with this format.</p>
</div>
<div class="paragraph">
<p>In this case, you could either:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Restore the backup using <code>cbbackupmgr</code> from 6.5.x, 6.6.x, 7.0.x or 7.1.x.</p>
</li>
<li>
<p>Merge two or more backups using <code>cbbackupmgr</code> from 6.5.x, 6.6.x, 7.0.x or
7.1.x then restore it using the latest version.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="REPLACE_TTL"><a class="anchor" href="#REPLACE_TTL"></a>REPLACE TTL</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The behavior of the --replace-ttl/--replace-ttl-with flags is well defined,
however, there are some conditions where the behavior may seem surprising or
unexpected due to conflict resolution.</p>
</div>
<div class="paragraph">
<p>Imagine the case where a backup contains one or more documents which have an
expiry which has now elapsed. There are several possible scenarios which could
take place when restoring these documents when using the <code>--replace-ttl</code> and
<code>--replace-ttl-with</code> flags. These scenarios are enumerated below.</p>
</div>
<div class="sect2">
<h3 id="restoring-to-a-new-clusterbucket"><a class="anchor" href="#restoring-to-a-new-clusterbucket"></a>RESTORING TO A NEW CLUSTER/BUCKET</h3>
<div class="paragraph">
<p>When restoring to a new cluster it&#8217;s expected that all the documents which match
the all/expired condition will be restored with their new/updated ttl values.</p>
</div>
</div>
<div class="sect2">
<h3 id="restoring-to-the-same-bucket"><a class="anchor" href="#restoring-to-the-same-bucket"></a>RESTORING TO THE SAME BUCKET</h3>
<div class="paragraph">
<p>The most interesting/unexpected cases occur when restoring the backup to the
same bucket at some point in the future.</p>
</div>
<div class="sect3">
<h4 id="expired-documents-have-not-been-purged"><a class="anchor" href="#expired-documents-have-not-been-purged"></a>EXPIRED DOCUMENTS HAVE NOT BEEN PURGED</h4>
<div class="paragraph">
<p>In the event that the restore takes place and the expired documents have not
been purged yet, conflict resolution will take precedence and the documents will
not be restored. This behavior will manifest itself as skipped mutations which
will be displayed in restore sub-command output.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Restoring backup '2021-05-17T11_00_15.843794944+01_00'
Copied all data in 1.773s (Avg. 21.03MiB/Sec)                                                                           31591 items / 21.03MiB
[====================================================================================================================================] 100.00%

| Transfer
| --------
| Status    | Avg Transfer Rate | Started At                        | Finished At                     | Duration |
| Succeeded | 21.03MiB          | Mon, 17 May 2021 11:00:25 +0100/s | Mon, 17 May 2021 11:00:26 +0100 | 1.785s   |

| Bucket
| ------
| Name          | Status    | Transferred | Avg Transfer Rate | Started At                      | Finished At                     | Duration |
| travel-sample | Succeeded | 21.03MiB    | 21.03MiB/s        | Mon, 17 May 2021 11:00:25 +0100 | Mon, 17 May 2021 11:00:26 +0100 | 1.713s   |
|
| Mutations                    | Deletions                    | Expirations                  |
| ---------                    | ---------                    | -----------                  |
| Received | Errored | Skipped | Received | Errored | Skipped | Received | Errored | Skipped |
| 0        | 0       | 31591   | 0        | 0       | 0       | 0        | 0       | 0       |

Restore completed successfully</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="expired-documents-have-been-purged"><a class="anchor" href="#expired-documents-have-been-purged"></a>EXPIRED DOCUMENTS HAVE BEEN PURGED</h4>
<div class="paragraph">
<p>If the restore is performed after the user-defined purge interval where a
compaction has taken place, the documents would be restored because the expired
documents would no longer exist in the cluster.</p>
</div>
</div>
<div class="sect3">
<h4 id="forcing-updates"><a class="anchor" href="#forcing-updates"></a>FORCING UPDATES</h4>
<div class="paragraph">
<p>The above behavior may be overridden by using the <code>--force-updates</code> flag which
will bypass conflict resolution and result in the documents from the backup
being restored.</p>
</div>
<div class="paragraph">
<p>The <code>--force-updates</code> flag will affect all the documents being restored and not
just those which contain an expiry which is being replaced.  This may result in
documents being overwritten with older versions from the backup; if the expired
documents keys are known beforehand, a mixed use of <code>--force-updates</code> and
<code>--filter-keys</code> may be more precise.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="examples"><a class="anchor" href="#examples"></a>EXAMPLES</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The restore command can be used to restore a single backup or range of backups
in a backup repository. In the examples below, we will look a few different ways
to restore data from a backup repository. All examples will assume that the
backup archive is located at /data/backups and that all backups are located in
the "example" backup repository.</p>
</div>
<div class="paragraph">
<p>The first thing to do when getting ready to restore data is to decide which
backups to restore. The easiest way to do this is to use the info command to see
which backups are available to restore.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ cbbackupmgr info --archive /data/backups --repo example --all
| Repo
| ----
| Name    | Size    | # Backups | Encrypted | Point in Time |
| example | 4.38MiB | 3         | false     | false         |
|
| Backups
| -------
|
| * Backup
|   ------
|   Name                             | Size    | Type | Complete |
|   2020-06-02T07_49_11.281004+01_00 | 1.69MiB | FULL | true     |
|
|   Merged Range
|   ------------
|   Start | End | Count |
|   N/A   | N/A | N/A   |
|
|   Cluster
|   -------
|   Hostname              | UUID                             |
|   http://localhost:8091 | c044f5eeb1dc16d0cd49dac29074b5f9 |
|
|   Services
|   --------
|
|     Eventing
|     --------
|     Functions |
|     0         |
|
|     FTS
|     ---
|     Aliases |
|     1       |
|
|     Query
|     -----
|     UDFs |
|     0    |
|
|   Buckets
|   -------
|
|  -  Bucket
|     ------
|     Name    | Size    |
|     example | 1.69MiB |
|
|     Services
|     --------
|
|       Data
|       ----
|       Mutations | Deletions | Size    |
|       4096      | 0         | 1.69MiB |
|
|         Point in Time
|         -------------
|         Mutations | Deletions | Duplicate Size |
|         4096      | 0         | 0B             |
|
|       Views
|       -----
|       Definitions |
|       0           |
|
|       Analytics
|       ---------
|       CBAS |
|       0    |
|
|       FTS
|       ---
|       Aliases |
|       0       |
|
|       Indexing
|       --------
|       Indexes |
|       0       |
|
| * Backup
|   ------
|   Name                             | Size    | Type | Complete |
|   2020-06-03T07_49_52.577901+01_00 | 1.34MiB | INCR | true     |
|
|   Merged Range
|   ------------
|   Start | End | Count |
|   N/A   | N/A | N/A   |
|
|   Cluster
|   -------
|   Hostname              | UUID                             |
|   http://localhost:8091 | c044f5eeb1dc16d0cd49dac29074b5f9 |
|
|   Services
|   --------
|
|     Eventing
|     --------
|     Functions |
|     0         |
|
|     FTS
|     ---
|     Aliases |
|     1       |
|
|     Query
|     -----
|     UDFs |
|     0    |
|
|   Buckets
|   -------
|
|  -  Bucket
|     ------
|     Name    | Size    |
|     example | 1.34MiB |
|
|     Services
|     --------
|
|       Data
|       ----
|       Mutations | Deletions | Size    |
|       2048      | 0         | 1.34MiB |
|
|         Point in Time
|         -------------
|         Mutations | Deletions | Duplicate Size |
|         2048      | 0         | 0B             |
|
|       Views
|       -----
|       Definitions |
|       0           |
|
|       Analytics
|       ---------
|       CBAS |
|       0    |
|
|       FTS
|       ---
|       Aliases |
|       0       |
|
|       Indexing
|       --------
|       Indexes |
|       0       |
|
| * Backup
|   ------
|   Name                             | Size    | Type | Complete |
|   2020-06-04T07_50_06.908787+01_00 | 1.34MiB | INCR | true     |
|
|   Merged Range
|   ------------
|   Start | End | Count |
|   N/A   | N/A | N/A   |
|
|   Cluster
|   -------
|   Hostname              | UUID                             |
|   http://localhost:8091 | c044f5eeb1dc16d0cd49dac29074b5f9 |
|
|   Services
|   --------
|
|     Eventing
|     --------
|     Functions |
|     0         |
|
|     FTS
|     ---
|     Aliases |
|     1       |
|
|     Query
|     -----
|     UDFs |
|     0    |
|
|   Buckets
|   -------
|
|  -  Bucket
|     ------
|     Name    | Size    |
|     example | 1.34MiB |
|
|     Services
|     --------
|
|       Data
|       ----
|       Mutations | Deletions | Size    |
|       2048      | 0         | 1.34MiB |
|
|         Point in Time
|         -------------
|         Mutations | Deletions | Duplicate Size |
|         2048      | 0         | 0B             |
|
|       Views
|       -----
|       Definitions |
|       0           |
|
|       Analytics
|       ---------
|       CBAS |
|       0    |
|
|       FTS
|       ---
|       Aliases |
|       0       |
|
|       Indexing
|       --------
|       Indexes |
|       0       |</pre>
</div>
</div>
<div class="paragraph">
<p>From the information of the backup repository we can see we have three backups
that we can restore in the "examples" backup repository. If we just want to
restore one of them we set the --start and --end flags in the restore command
to the same backup name and specify the cluster that we want to restore the data
to. In the example below we will restore only the oldest backup.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cbbackupmgr restore -a /data/backups -r example \
 -c couchbase://127.0.0.1 -u Administrator -p password \
 --start 2020-06-02T07_49_11.281004+01_00 \
 --end 2020-06-02T07_49_11.281004+01_00</pre>
</div>
</div>
<div class="paragraph">
<p>If we want to restore only the two most recent backups then we specify the
--start and --end flags with different backup names in order to specify the
range we want to restore.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cbbackupmgr restore -a /data/backups -r example \
 -c couchbase://127.0.0.1 -u Administrator -p password \
 --start 2020-06-02T07_49_11.281004+01_00 \
 --end 2020-06-03T07_49_52.577901+01_00</pre>
</div>
</div>
<div class="paragraph">
<p>If we want to restore all of the backups in the "examples" directory then we can
omit the --start and --end flags since their default values are the oldest and
most recent backup in the backup repository.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cbbackupmgr restore -a /data/backups -r example \
 -c couchbase://127.0.0.1 -u Administrator -p password</pre>
</div>
</div>
<div class="paragraph">
<p>Restore also allows filtering the data restored by document key and/or value by passing
regular expressions to the flags <code>--filter-keys</code> and <code>--filter-values</code> respectively.
Say we backup the sample bucket 'beer-sample' if we only wanted to restore only the
documents that have a key that starts with '21st_amendment_brewery_cafe'. This can be
done using the flag <code>--filter-keys</code> as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ cbbackupmg restore -c http://127.0.0.1:8091 -u Administrator -p password \
 -a /data/backups -r beer --filter-keys '^21st_amendment_brewery_cafe.*'</pre>
</div>
</div>
<div class="paragraph">
<p>Restore also allows filtering by value. Let&#8217;s say we only want to restore documents that
contain the JSON field <code>address</code>. This could be done by passing the regular expression
<code>{.*"address":.*}</code> to the <code>--filter-values</code> flag as illustrated below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ cbbackupmgr restore -c http://127.0.0.1:8091 -u Administrator -p password \
 -a /data/backups -r beer --filter-values '{.*"address":.*}'</pre>
</div>
</div>
<div class="paragraph">
<p>Restore also allows overwriting users. Let&#8217;s say we want to restore all the users and
overwrite any existing ones, as restore skips existing users by default. This
could be done by passing the <code>--overwrite-users</code> flag as illustrated below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ cbbackupmgr restore -c http://127.0.0.1:8091 -u Administrator -p password \
 -a /data/backups -r beer --overwrite-users</pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we can combine both flags to filter by both key and value. Imagine you want to
restore the values for beers that start with the key '21st_amendment_brewery_cafe' and
have the JSON field <code>"category":"North American Ale"</code>. This can be done by using
the command below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ cbbackupmgr restore -c http://127.0.0.1:8091 -u Administrator -p password \
 -a /data/backups -r beer --filter-values '{.*"category":"North American Ale".*}' \
 --filter-keys '^21st_amendment_brewery_cafe.*'</pre>
</div>
</div>
<div class="paragraph">
<p>By combining the <code>--force-updates</code> flag, along with the  <code>--filter-key</code> and/or <code>--filter-value</code> flags, we can restore documents quickly and selectively in a single operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ cbbackupmgr -c http://127.0.0.1:8091 -u Administrator -p password \
 -a /data/backups -r beer--force-updates --filter-values '{.*"category":"North American Ale".*}' \
 --filter-keys '^21st_amendment_brewery_cafe.*'</pre>
</div>
</div>
<div class="paragraph">
<p>The regular expressions provided must follow <a href="https://github.com/google/re2/wiki/Syntax">RE2 syntax</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CHECKSUM_FAILURE"><a class="anchor" href="#CHECKSUM_FAILURE"></a>CHECKSUM FAILURE</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A checksum failure may occur during a restore and indicates that a document
has changed since the creation of the backup. Depending on the type of corruption
we may be able to restore by skipping only the corrupted documents. However, if the
size of the data file has changed (e.g. not a bit flip or byte for byte modification)
<strong>all</strong> documents after the corruption (for that vBucket) will be unusable.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="automatic-collection-creation"><a class="anchor" href="#automatic-collection-creation"></a>AUTOMATIC COLLECTION CREATION</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By design, users may not recreate the <code>_default</code> collection once it has been
deleted. Therefore, this means that the <code>_default</code> collection can&#8217;t (and won&#8217;t)
be recreated if it&#8217;s missing. Before performing a transfer, a check will take
place to see if the <code>_default</code> collection will be required when it&#8217;s missing.
If this is the case, the command will exit early and you will be required to
remap the <code>_default</code> collection using the <code>--map-data</code> flag.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="automatic-collection-deletion"><a class="anchor" href="#automatic-collection-deletion"></a>AUTOMATIC COLLECTION DELETION</h2>
<div class="sectionbody">
<div class="paragraph">
<p>During a backup cbbackupmgr will take note of which scopes/collections were
create/deleted/modified up to the point that the backup began.  This behavior
can be leveraged to automatically delete any scopes/collections which are
marked as deleted in the backup. We will only delete scopes/collections which
are identical to the ones which are stored in the backup; ones which match by
both id and name.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="REMAPPING"><a class="anchor" href="#REMAPPING"></a>REMAPPING</h2>
<div class="sectionbody">
<div class="paragraph">
<p>During a transfer, scopes/collections can be remapped from one location to
another. There are several rules that are enforced when remapping
scopes/collections, they are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You must be running an Enterprise Edition version of Couchbase Server.</p>
</li>
<li>
<p>You may not remap the <code>_default</code> scope (discussed in THE DEFAULT SCOPE).</p>
</li>
<li>
<p>You may not restore users while remapping scopes/collections, the restoring of
users will be skipped.</p>
</li>
<li>
<p>You may only remap scopes/collections at the same level meaning scopes may
be remapped to other scopes, and collections to other collections, however, a
scope can&#8217;t be remapped to a collection or vice versa.</p>
</li>
<li>
<p>Scopes/collections may only be remapped within the same bucket. For example
the mapping <code>bucket1.scope.collection=bucket2.scope.collection</code> is invalid.</p>
</li>
<li>
<p>Scopes/collections may only be remapped once. For example the mapping
<code>bucket1.scope1=bucket1.scope2,bucket1.scope1=bucket1.scope3</code> is invalid.</p>
</li>
<li>
<p>Remapping may only take place at one level at once meaning that if a parent
bucket/scope is already remapped, the child scopes/collections may not also
be remapped. For example the mapping
<code>bucket1.scope1=bucket1.scope2,bucket1.scope1.collection1=bucket1.scope3.collection9</code>
is invalid.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="remapping-a-scopecollection-without-renaming"><a class="anchor" href="#remapping-a-scopecollection-without-renaming"></a>REMAPPING A SCOPE/COLLECTION WITHOUT RENAMING</h3>
<div class="paragraph">
<p>During a transfer, it&#8217;s possible for a scope/collection to encounter a conflict
(for example, because it has been recreated). It may not be preferable to
rename the scope/collection during the transfer.</p>
</div>
<div class="paragraph">
<p>For this reason, the <code>--map-data</code> flag, allows you to remap a scope/collection
to itself; this indicates that the scope/collection that exists in the target
(with a different id) should be treated as the same.</p>
</div>
<div class="paragraph">
<p>As an example, the following error message indicates that a collection has been
recreated prior to a restore.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Error restoring cluster: collection 8 with name 'collection1' in the scope '_default' exists with a different name/id on the cluster, a manual remap is required</pre>
</div>
</div>
<div class="paragraph">
<p>Using the <code>--map-data</code> flag with the argument
<code>bucket._default.collection1=bucket._default.collection1</code> would cause
<code>cbbackupmgr</code> to treat <code>collection1</code> (with id 8) as <code>collection1</code> (with the id
it exists with in the target).</p>
</div>
</div>
<div class="sect2">
<h3 id="the-default-scope"><a class="anchor" href="#the-default-scope"></a>THE DEFAULT SCOPE</h3>
<div class="paragraph">
<p>As mentioned in AUTOMATIC COLLECTION CREATION, it&#8217;s not possible to recreate
the <code>_default</code> scope/collection. This means you can&#8217;t remap the <code>_default</code>
scope because the tool may be unable to create a destination scope/collection.
This may be worked around by remapping each collection inside the <code>_default</code>
scope.</p>
</div>
</div>
<div class="sect2">
<h3 id="bucket-to-collection-remapping"><a class="anchor" href="#bucket-to-collection-remapping"></a>BUCKET TO COLLECTION REMAPPING</h3>
<div class="paragraph">
<p>As discussed in REMAPPING, it&#8217;s not possible to remap data at different levels;
buckets must be remapped to buckets, scopes to scopes and collections to
collections. However, there is one supported edge case, which is remapping a
bucket into a collection to allow migration from a collection unaware to
collection aware datasets.</p>
</div>
<div class="paragraph">
<p>To remap a bucket into a collection using <code>--map-data</code> you may supply
<code>--map-data bucket._default._default=bucket.scope.collection</code>. This
functionality is compatible with cross bucket mapping, for example you may also
supply <code>--map-data bucket1._default._default=bucket2.scope.collection</code>.</p>
</div>
<div class="paragraph">
<p>Note that once you&#8217;ve provided a mapping to remap a bucket into a collection
you may not remap that bucket elsewhere. For example <code>--map-data
bucket1._default._default=bucket2.scope.collection,bucket1=bucket3</code> is invalid.</p>
</div>
</div>
<div class="sect2">
<h3 id="remapping-multiple-data-sources-into-a-single-target-source"><a class="anchor" href="#remapping-multiple-data-sources-into-a-single-target-source"></a>REMAPPING MULTIPLE DATA SOURCES INTO A SINGLE TARGET SOURCE</h3>
<div class="paragraph">
<p>As outlined in the rules discussed in REMAPPING, it&#8217;s not possible to remap a
bucket/scope/collection multiple times, however, it is possible to remap to a
single destination multiple times. For example the mapping
<code>bucket1=dest,bucket2=dest,bucket3=dest</code> is valid.</p>
</div>
<div class="paragraph">
<p>Although valid, this manor of remapping is dangerous and can result in data not
being transferred due to conflicting key spaces. If this style of remapping is
detected a warning will be printed before proceeding.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="restoring-a-collection-aware-backup-to-a-collection-unaware-cluster"><a class="anchor" href="#restoring-a-collection-aware-backup-to-a-collection-unaware-cluster"></a>RESTORING A COLLECTION AWARE BACKUP TO A COLLECTION UNAWARE CLUSTER</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The restore sub-command supports restoring collection aware backups to
collection unaware cluster. When restoring a collection aware backup to a
cluster which doesn&#8217;t support collections, <code>cbbackupmgr</code> will restore the
<code>_default._default</code> collection into the target bucket; no data will be
transferred for any other collections.</p>
</div>
<div class="paragraph">
<p>This allows you to utilize a collection aware cluster, without using the
collections feature and still be able to restore your data to a cluster which
is running a previous version of Couchbase which is collection unaware.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="discussion"><a class="anchor" href="#discussion"></a>DISCUSSION</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The restore command works by replaying the data recorded in backup files. During
a restore, each key-value pair backed up by cbbackupmgr will be sent to the
cluster as either a "set" or "delete" operation. The restore command replays
data from each file in order of backup time to guarantee that older backup data
does not overwrite newer backup data. The restore command uses Couchbase&#8217;s
conflict resolution mechanism by default to ensure this behavior. The conflict
resolution mechanism can be disabled by specifying the --force-updates flag when
executing a restore.</p>
</div>
<div class="paragraph">
<p>Starting in Couchbase 4.6 each bucket can have different conflict resolution
mechanisms. cbbackupmgr will backup all meta data used for conflict resolution,
but since each conflict resolution mechanism is different cbbackupmgr will
prevent restores to a bucket when the source and destination conflict resolution
methods differ. This is done because by default cbbackupmgr will use the
conflict resolution mechanism of the destination bucket to ensure an older value
does not overwrite a newer value. If you want to restore a backup to a bucket
with a different conflict resolution type you can do by using the
--force-updates flag. This is allowed because forcing updates means that
cbbackupmgr will skip doing conflict resolution on the destination bucket.</p>
</div>
<div class="paragraph">
<p>Like backups, restores may be resumed if they fail using the <code>--resume</code> flag.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="environment-and-configuration-variables"><a class="anchor" href="#environment-and-configuration-variables"></a>ENVIRONMENT AND CONFIGURATION VARIABLES</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">CB_CLUSTER</dt>
<dd>
<p>Specifies the hostname of the Couchbase cluster to connect to. If the
hostname is supplied as a command line argument then this value is
overridden.</p>
</dd>
<dt class="hdlist1">CB_USERNAME</dt>
<dd>
<p>Specifies the username for authentication to a Couchbase cluster. If the
username is supplied as a command line argument then this value is
overridden.</p>
</dd>
<dt class="hdlist1">CB_PASSWORD</dt>
<dd>
<p>Specifies the password for authentication to a Couchbase cluster. If the
password is supplied as a command line argument then this value is
overridden.</p>
</dd>
<dt class="hdlist1">CB_CLIENT_CERT</dt>
<dd>
<p>The path to a client certificate used to authenticate when connecting to a
cluster. May be supplied with <code>CB_CLIENT_KEY</code> as an alternative to the
<code>CB_USERNAME</code> and <code>CB_PASSWORD</code> variables. See the <a href="#CERTIFICATE_AUTHENTICATION">CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</a>
section for more information.</p>
</dd>
<dt class="hdlist1">CB_CLIENT_CERT_PASSWORD</dt>
<dd>
<p>The password for the certificate provided to the <code>CB_CLIENT_CERT</code> variable,
when using this variable, the certificate/key pair is expected to be in the
PKCS#12 format. See the <a href="#CERTIFICATE_AUTHENTICATION">CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</a> section for more
information.</p>
</dd>
<dt class="hdlist1">CB_CLIENT_KEY</dt>
<dd>
<p>The path to the client private key whose public key is contained in the
certificate provided to the <code>CB_CLIENT_CERT</code> variable. May be supplied with
<code>CB_CLIENT_CERT</code> as an alternative to the <code>CB_USERNAME</code> and <code>CB_PASSWORD</code>
variables. See the <a href="#CERTIFICATE_AUTHENTICATION">CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</a> section for more information.</p>
</dd>
<dt class="hdlist1">CB_CLIENT_KEY_PASSWORD</dt>
<dd>
<p>The password for the key provided to the <code>CB_CLIENT_KEY</code> variable, when using
this variable, the key is expected to be in the PKCS#8 format.  See the
<a href="#CERTIFICATE_AUTHENTICATION">CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</a> section for more information.</p>
</dd>
<dt class="hdlist1">CB_ARCHIVE_PATH</dt>
<dd>
<p>Specifies the path to the backup archive. If the archive path is supplied as
a command line argument then this value is overridden.</p>
</dd>
<dt class="hdlist1">CB_OBJSTORE_STAGING_DIRECTORY</dt>
<dd>
<p>Specifies the path to the staging directory. If the <code>--obj-staging-dir</code>
argument is provided in the command line then this value is overridden.</p>
</dd>
<dt class="hdlist1">CB_OBJSTORE_REGION</dt>
<dd>
<p>Specifies the object store region. If the <code>--obj-region</code> argument is provided
in the command line then this value is overridden.</p>
</dd>
<dt class="hdlist1">CB_OBJSTORE_ACCESS_KEY_ID</dt>
<dd>
<p>Specifies the object store access key id. If the <code>--obj-access-key-id</code>
argument is provided in the command line this value is overridden.</p>
</dd>
<dt class="hdlist1">CB_OBJSTORE_SECRET_ACCESS_KEY</dt>
<dd>
<p>Specifies the object store secret access key. If the
<code>--obj-secret-access-key</code> argument is provided in the command line this value
is overridden.</p>
</dd>
<dt class="hdlist1">CB_OBJSTORE_REFRESH_TOKEN</dt>
<dd>
<p>Specifies the refresh token to use. If the <code>--obj-refresh-token</code> argument is
provided in the command line, this value is overridden.</p>
</dd>
<dt class="hdlist1">CB_AWS_ENABLE_EC2_METADATA</dt>
<dd>
<p>By default cbbackupmgr will disable fetching EC2 instance metadata. Setting
this environment variable to true will allow the AWS SDK to fetch metadata
from the EC2 instance endpoint.</p>
</dd>
<dt class="hdlist1">CB_ENCRYPTION_PASSPHRASE</dt>
<dd>
<p>Specifies the passphrase used for encryption.</p>
</dd>
<dt class="hdlist1">CB_KM_KEY_URL</dt>
<dd>
<p>Specifies the URL identifying the encryption key on the KMS. See
<code>--km-key-url</code> for the expected format and accepted KMSs.</p>
</dd>
<dt class="hdlist1">CB_KM_ACCESS_ID</dt>
<dd>
<p>Specifies the key/user ID used to connect to the KMS.</p>
</dd>
<dt class="hdlist1">CB_KM_SECRET_ACCESS_KEY</dt>
<dd>
<p>Specifies the secret key/token used to connect to the KMS.</p>
</dd>
<dt class="hdlist1">CB_KM_AUTH_FILE</dt>
<dd>
<p>Specifies a path to a file containing the required credentials to connect to
the KMS.</p>
</dd>
<dt class="hdlist1">CB_KM_TENANT_ID</dt>
<dd>
<p>Specifies the cloud provider tenant to connect to the KMS with. This value is
only for when using access key authentication in Azure.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="see-also"><a class="anchor" href="#see-also"></a>SEE ALSO</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="cbbackupmgr-backup.html" class="xref page">cbbackupmgr-backup</a>,
<a href="cbbackupmgr-info.html" class="xref page">cbbackupmgr-info</a>,
<a href="cbbackupmgr-cloud.html" class="xref page">cbbackupmgr-cloud</a>
<a href="cbbackupmgr-network-filesystems.html" class="xref page">cbbackupmgr-network-filesystems</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cbbackupmgr"><a class="anchor" href="#cbbackupmgr"></a>CBBACKUPMGR</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Part of the <a href="cbbackupmgr.html" class="xref page">cbbackupmgr</a> suite</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span> 2024 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Server","components":["server"],"url":"/home/server.html","latestVersions":{"server":"7.6"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../_/js/vendor/chatbox-ui.js"></script>
<script id="site-script" src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab"></script>
<script defer src="../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
</body>
</html>
