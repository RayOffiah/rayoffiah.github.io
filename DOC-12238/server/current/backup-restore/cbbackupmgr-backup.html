<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv=content-security-policy content="default-src 'none'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https://fonts.gstatic.com; frame-src 'self' https:; img-src 'self' data: https:; connect-src 'self' https:; worker-src blob:;">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://metrics.couchbase.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MVPNN2');</script>
<!-- End Google Tag Manager -->
<title>cbbackupmgr backup | Couchbase Docs</title>
<link rel="canonical" href="https://docs.couchbase.com/server/current/backup-restore/cbbackupmgr-backup.html">
<link rel="stylesheet" href="../../../_/css/site.css">
<script src="../../../_/js/vendor/jquery.js"></script>
<meta name="description" content="Backs up data from a Couchbase cluster">
<link rel="schema.dcterms" href="https://purl.org/dc/terms/">


<meta name="dcterms.subject" content="server">
<meta name="dcterms.identifier" content="7.6">
<meta name="page-url" content="/server/current/backup-restore/cbbackupmgr-backup.html">
<meta name="page-nav-header-levels" content="0">
<meta name="generator" content="Antora 3.1.7">
<link rel="icon" href="../../../_/img/favicon.svg" type="image/svg+xml">
<link rel="icon" href="../../../_/img/favicon.ico" type="image/x-icon" sizes="any">
</head>
<body class="article">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MVPNN2" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<header class="header fixed-top">
  <div class="header-top-row">
      <div class="container">
          <nav class="navbar navbar-expand-md flex-nowrap justify-content-between navbar-new-top">
              <ul class="navbar-brand-list">
                <li class="brand-logo">
                  <a class="navbar-brand" href="https://www.couchbase.com">
                    <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase" />
                  </a>
                </li>
                <li>
                  <a class="navbar-brand cb-documentation" href="https://docs.couchbase.com/home/index.html">
                    <img src="../../../_/img/cb-documentation.svg" alt="Couchbase Documentation" class="cb-docs" />
                    <img src="../../../_/img/cb-docs-hover.svg" alt="Couchbase Documentation" class="hide cb-hover-docs" />
                  </a>
                </li>
              </ul>
              <button class="navbar-burger" data-target="topbar-menu">
                <span></span>
                <span></span>
                <span></span>
              </button>

          </nav>
      </div>
  </div>
  <div class="header-bottom-row" id="topbar-menu">
    <div class="container">
        <nav  class="navbar navbar-new-bottom">

              <div class="navbar-collapse collapse" id="navbar2">
                <ul class="navbar-nav w-100 justify-content-start">
                  <li class="nav-item">
                    <a href="https://docs.couchbase.com/home/index.html" class="nav-link">
                      <i class="fas fa-home"></i>
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/server.html">
                      Server
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="../../../home/mobile.html">
                      Mobile
                    </a>
                  </li>
                </ul>
              </div>
              <div class="primary-action">
                <a class="btn btn-primary btn-grey-reverse" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Download'});" href="https://www.couchbase.com/downloads">
                  Downloads
                  <i class="far fa-arrow-to-bottom fa-fw"></i>
                </a>
                <a href="https://cloud.couchbase.com/sign-up" class="btn btn-primary" onclick="(window.dataLayer=window.dataLayer||[]).push({'event':'customEvent', 'category':'CTA', 'action':'Button Click',  'label':'Free Trial'});" >
                  Start Free Trial
                  <i class="far fa-cloud fa-fw"></i>
                </a>

              </div>

        </nav>
    </div>
   </div>
</header>
<div class="body container">
<aside class="nav left-sidebar">
  <div class="nav-container">
    <a href="#" class="menu-expand-toggle"><span>Navigation</span><i class="fas fa-times-circle"></i><i class="fas fa-chevron-circle-left"></i></a>
    <template id="page-versions" style="display: none">
      <select class="version_list" data-component="server">
        <option value="7.6" data-url="cbbackupmgr-backup.html" selected>7.6</option>
        <option value="7.2" data-url="../../7.2/index.html">7.2</option>
        <option value="7.1" data-url="../../7.1/index.html">7.1</option>
        <option value="7.0" data-url="../../7.0/index.html">7.0</option>
        <option value="6.6" data-url="../../6.6/index.html">6.6</option>
        <option value="6.5" data-url="../../6.5/index.html">6.5</option>
        <option value="6.0" data-url="../../6.0/index.html">6.0</option>
      </select>
    </template>
  </div>
</aside>
<aside class="toc sidebar"
      data-title="Contents"
      data-levels="1">
  <div class="sidebar-box">
    <div class="tools" role="navigation">
<ul>
<li class="tool edit"><a href="file:///Users/rayoffiah/projects/couchbase/backup/docs/modules/backup-restore/pages/cbbackupmgr-backup.adoc" title="Edit Page" target="_blank" rel="noopener" class="remove-ext-icon">Edit on GitHub</a></li>
</ul>
</div>
    <div class="toc-menu"></div>
    <div class="is-this-helpful-box">
      <h4> Is this page helpful?</h4>
      <div class="btn-row">
        <a href="#" class="like-btn helpful-btn" id="yesBtn" data-page-rating="like" >
                <i class="far fa-thumbs-up"></i>
            Yes

            </a>
        <a href="#" class="dislike-btn helpful-btn" id="noBtn"  data-page-rating="dislike"> <i class="far fa-thumbs-down"></i> No</a>
      </div>
      <div class="any-feedback">
        <a href="#" class="btn any-feedback-btn" id="myCustomTrigger">Leave Additional Feedback? </a>
      </div>
      <div class="dialog-box" id="dialogBox">
        <form>
            <div class="form-group " id="additionalFeedbackBox">
              <textarea class="input-control feed-back-msg" rows="8" placeholder="Any Additonal Feedback?"></textarea>

              <div class="action-btn-row ">
                <a href="#" class="skip-btn" id="skipBtnMsg">Skip</a>
                  <button class="submit-btn btn blue-btn disabled" > Submit  </button>
                  <a href="#" class="info-btn"><i class="fas fa-info-circle"></i></a>
              </div>


            </div>

        </form>

      </div>
    </div>
  </div>

</aside>

<div class="feedback-modal modal-popup">
  <div class="modal-popup-dialogue">
    <div class="popup-header">
      <a href="#" class="close-popup"><i class="fa fa-times"></i></a>
    </div>
    <div class="popup-content">
      <p>
        Please use the form below to provide your feedback. Because your feedback is valuable to us,
         the information you submit in this form is recorded in our issue tracking system (JIRA), which is publicly available.
        You can track the status of your feedback using the ticket number displayed in the dialog once you submit the form.
      </p>
    </div>
  </div>
</div>

<main class="article" data-ceiling="topbar">
<div class="article-header">
<nav class="crumbs" aria-label="breadcrumbs">
<ul>
<li class="crumb"><a href="../introduction/intro.html">Couchbase Server</a></li>
<li class="crumb">Reference</li>
<li class="crumb"><a href="../cli/cli-intro.html">CLI Reference</a></li>
<li class="crumb"><a href="cbbackupmgr.html">cbbackupmgr</a></li>
<li class="crumb"><a href="cbbackupmgr-backup.html">cbbackupmgr backup</a></li>
</ul>
</nav>
</div>
<article class="doc">
<div class="page-heading-title">
<h1 class="page">cbbackupmgr backup</h1>
<div class="labels">
<ul></ul>
</div>


</div>
<div class="contributor-list-box">
<span class="last-commit-date" id="commitdate">    </span>
<ul id="contributorList"></ul>
<span  id="otherContributor"> + </span>
</div><div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Backs up data from a Couchbase cluster</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="synopsis"><a class="anchor" href="#synopsis"></a>SYNOPSIS</h2>
<div class="sectionbody">
<div class="verseblock">
<pre class="content">cbbackupmgr backup [--archive &lt;archive_dir&gt;] [--repo &lt;repo_name&gt;]
                   [--cluster &lt;url&gt;] [--username &lt;username&gt;]
                   [--password &lt;password&gt;] [--client-cert &lt;path&gt;]
                   [--client-cert-password &lt;password&gt;] [--client-key &lt;path&gt;]
                   [--client-key-password &lt;password&gt;] [--resume] [--purge]
                   [--threads &lt;num&gt;] [--cacert &lt;file&gt;] [--no-ssl-verify]
                   [--value-compression &lt;type&gt;] [--no-progress-bar]
                   [--skip-last-compaction] [--consistency-check &lt;window&gt;]
                   [--full-backup] [--obj-access-key-id &lt;access_key_id&gt;]
                   [--obj-cacert &lt;cert_path&gt;] [--obj-endpoint &lt;endpoint&gt;]
                   [--obj-no-ssl-verify] [--obj-region &lt;region&gt;]
                   [--obj-staging-dir &lt;staging_dir&gt;]
                   [--obj-secret-access-key &lt;secret_access_key&gt;]
                   [--s3-force-path-style] [--s3-log-level &lt;level&gt;]
                   [--passphrase &lt;passphrase&gt;] [--km-key-url &lt;url&gt;]
                   [--km-endpoint &lt;endpoint&gt;] [--km-region &lt;region&gt;]
                   [--km-access-key-id &lt;id&gt;] [--km-secret-access-key &lt;key&gt;]
                   [--km-auth-file &lt;path&gt;]</pre>
</div>
</div>
</div>
<div class="sect1">
<h2 id="description"><a class="anchor" href="#description"></a>DESCRIPTION</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Backs up a Couchbase cluster into the backup repository specified. Before
running the backup command, a backup repository must be created. See
<a href="cbbackupmgr-config.html" class="xref page">cbbackupmgr-config</a> for more details on creating a backup
repository. The backup command uses information from the previous backup taken
in order to backup all new data on a Couchbase cluster. If no previous backup
exists then all data on the cluster is backed up. The backup is taken based on
the backup repository&#8217;s backup configuration. Each backup will create a new
folder in the backup repository. This folder will contain all data from the
backup and is named to reflect the time that the backup was started.</p>
</div>
<div class="paragraph">
<p>As the backup runs, it tracks its progress which allows failed backups to be
resumed from the point where they left off. If a backup fails before it is
complete it is considered a partial backup. To attempt to complete the backup
process, the backup may be resumed with the --resume flag. It may also be
deleted and resumed from the previous successful backup with the --purge flag.</p>
</div>
<div class="paragraph">
<p>The backup command is capable of backing up data when there is a cluster
rebalance operation in progress. During a rebalance, the backup command will
track data as it moves around the cluster and complete the backup. However, users
should use caution when running backups during a rebalance since both the
rebalance and backup operations can be resource intensive and may cause
temporary performance degradations in other parts of the cluster. See the
--threads flag for information on how to lower the impact of the backup command
on your Couchbase cluster.</p>
</div>
<div class="paragraph">
<p>The backup command is also capable of backing up data when there are server
failures in the target backup cluster. When a server failure occurs the backup
command will wait for 180 seconds for the failed server to come back online or
for the failed server to be failed over and removed from the cluster. If 180
seconds passes without the failed server coming back online or being failed over
then the backup command will mark the data on that node as failed and attempt to
back up the rest of the data from the cluster. The backup will be marked as a
partial backup in the backup archive and will need to be either resumed or
purged when the backup command is invoked again.</p>
</div>
<div class="paragraph">
<p>Note that if backing up a cluster running version 7.6 or above the <code>_system</code>
scope (used for internal Couchbase services) will be backed up too.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="options"><a class="anchor" href="#options"></a>OPTIONS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Below are a list of required and optional parameters for the backup command.</p>
</div>
<div class="sect2">
<h3 id="required"><a class="anchor" href="#required"></a>Required</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">-a,--archive &lt;archive_dir&gt;</dt>
<dd>
<p>The location of the backup archive directory. When backing up directly to S3
prefix the archive path with <code>s3://${BUCKET_NAME}/</code>.</p>
</dd>
<dt class="hdlist1">-r,--repo &lt;repo_name&gt;</dt>
<dd>
<p>The name of the backup repository to backup data into.</p>
</dd>
<dt class="hdlist1">-c,--cluster &lt;hostname&gt;</dt>
<dd>
<p>The hostname of one of the nodes in the cluster to back up. See the
<a href="#HOST_FORMATS">HOST FORMATS</a> section below for hostname specification details.</p>
</dd>
<dt class="hdlist1">-u,--username &lt;username&gt;</dt>
<dd>
<p>The username for cluster authentication. The user must have the appropriate
privileges to take a backup.</p>
</dd>
<dt class="hdlist1">-p,--password &lt;password&gt;</dt>
<dd>
<p>The password for cluster authentication. The user must have the appropriate
privileges to take a backup. If not password is supplied to this option then
you will be prompted to enter your password.</p>
</dd>
<dt class="hdlist1">--client-cert &lt;path&gt;</dt>
<dd>
<p>The path to a client certificate used to authenticate when connecting to a
cluster. May be supplied with <code>--client-key</code> as an alternative to the
<code>--username</code> and <code>--password</code> flags.  See the <a href="#CERTIFICATE_AUTHENTICATION">CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</a>
section for more information.</p>
</dd>
<dt class="hdlist1">--client-cert-password &lt;password&gt;</dt>
<dd>
<p>The password for the certificate provided to the <code>--client-cert</code> flag, when
using this flag, the certificate/key pair is expected to be in the PKCS#12
format. See the <a href="#CERTIFICATE_AUTHENTICATION">CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</a> section for more information.</p>
</dd>
<dt class="hdlist1">--client-key &lt;path&gt;</dt>
<dd>
<p>The path to the client private key whose public key is contained in the
certificate provided to the <code>--client-cert</code> flag. May be supplied with
<code>--client-cert</code> as an alternative to the <code>--username</code> and <code>--password</code>
flags. See the <a href="#CERTIFICATE_AUTHENTICATION">CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</a> section for more information.</p>
</dd>
<dt class="hdlist1">--client-key-password &lt;password&gt;</dt>
<dd>
<p>The password for the key provided to the <code>--client-key</code> flag, when using this
flag, the key is expected to be in the PKCS#8 format.
See the <a href="#CERTIFICATE_AUTHENTICATION">CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</a> section for more information.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="optional"><a class="anchor" href="#optional"></a>Optional</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">--resume</dt>
<dd>
<p>If the previous backup did not complete successfully it can be resumed from
where it left off by specifying this flag. Note that the resume and purge
flags may not be specified at the same time.</p>
</dd>
<dt class="hdlist1">--purge</dt>
<dd>
<p>If the previous backup did not complete successfully the partial backup will
be removed and restarted from the point of the previous successful backup by
specifying this flag. Note that the purge and resume flags may not be
specified at the same time.</p>
</dd>
<dt class="hdlist1">--no-ssl-verify</dt>
<dd>
<p>Skips the SSL verification phase. Specifying this flag will allow a
connection using SSL encryption, but will not verify the identity of the
server you connect to. You are vulnerable to a man-in-the-middle attack if
you use this flag. Either this flag or the --cacert flag must be specified
when using an SSL encrypted connection.</p>
</dd>
<dt class="hdlist1">--cacert &lt;cert_path&gt;</dt>
<dd>
<p>Specifies a CA certificate that will be used to verify the identity of the
server being connecting to. Either this flag or the --no-ssl-verify flag
must be specified when using an SSL encrypted connection.</p>
</dd>
<dt class="hdlist1">--value-compression &lt;compression_policy&gt;</dt>
<dd>
<p>Specifies a compression policy for backed up values. When Couchbase sends
data to the backup client the data stream may contain all compressed values,
all uncompressed values, or a mix of compressed and uncompressed values. To
backup all data in the same form that the backup client receives it you can
specify "unchanged". If you wish for all values to be uncompressed then you
can specify "uncompressed". This policy will however uncompress any
compressed values received from Couchbase and may increase the backup file
size. To compress all values you can specify "compressed". This will compress
any uncompressed values before writing them to disk. The default value for
this option is "compressed".</p>
</dd>
<dt class="hdlist1">-t,--threads &lt;num&gt;</dt>
<dd>
<p>Specifies the number of concurrent clients to use when taking a backup.
Fewer clients means backups will take longer, but there will be less cluster
resources used to complete the backup. More clients means faster backups,
but at the cost of more cluster resource usage. This parameter defaults to 1
if it is not specified and it is recommended that this parameter is not set
to be higher than the number of CPUs on the machine where the backup is
taking place.</p>
</dd>
<dt class="hdlist1">--no-progress-bar</dt>
<dd>
<p>By default, a progress bar is printed to stdout so that the user can see how
long the backup is expected to take, the amount of data that is being
transferred per second, and the amount of data that has been backed up.
Specifying this flag disables the progress bar and is useful when running
automated jobs.</p>
</dd>
<dt class="hdlist1">--consistency-check &lt;window&gt;</dt>
<dd>
<p>When a window larger than 1 is provided it will enable the consistency
checker. This will show a warning if the backup consistency window is larger
than the one provided in seconds. This is an Enterprise Edition feature and
is currently in developer preview. See <a href="#DISCUSSION">DISCUSSION</a> for more information.</p>
</dd>
<dt class="hdlist1">--full-backup</dt>
<dd>
<p>Force a full backup in the same backup repository. This can be used to more
easily manage backups.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="cloud-integration"><a class="anchor" href="#cloud-integration"></a>Cloud integration</h3>
<div class="paragraph">
<p>Native cloud integration is an Enterprise Edition feature which was introduced
in Couchbase Server 6.6.0.</p>
</div>
<div class="paragraph">
<p>Backing up directly to object store is only supported for Couchbase Server
6.6.0 and above. It&#8217;s likely that backing up older clusters will result in
significantly higher memory consumption.</p>
</div>
<div class="paragraph">
<p>Multiple cloud providers are supported, see the list below for more information.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Supported</p>
<div class="ulist">
<ul>
<li>
<p>AWS S3 (<code>s3://</code>)</p>
</li>
<li>
<p>GCP Google Storage (<code>gs://</code>)</p>
</li>
<li>
<p>Azure Blob Storage in 7.1.2+ (<code>az://</code>)</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="required-2"><a class="anchor" href="#required-2"></a>Required</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">--obj-staging-dir &lt;staging_dir&gt;</dt>
<dd>
<p>When performing an operation on an archive which is located in the cloud such
as AWS, the staging directory is used to store local meta data files. This
directory can be temporary (it&#8217;s not treated as a persistent store) and is
only used during the backup. NOTE: Do not use <code>/tmp</code> as the <code>obj-staging-dir</code>.
See <code>Disk requirements</code> in <a href="cbbackupmgr-cloud.html" class="xref page">cbbackupmgr-cloud</a> for more information.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="optional-2"><a class="anchor" href="#optional-2"></a>Optional</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">--obj-access-key-id &lt;access_key_id&gt;</dt>
<dd>
<p>The access key id which has access to your chosen object store. This option
can be omitted when using the shared config functionality provided by your
chosen object store. Can alternatively be provided using the
<code>CB_OBJSTORE_ACCESS_KEY_ID</code> environment variable.</p>
<div class="paragraph">
<p>When using AWS, this option expects an access key id. See
<a href="https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#access-keys-and-secret-access-keys" class="bare">https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#access-keys-and-secret-access-keys</a>
for more information.</p>
</div>
<div class="paragraph">
<p>When using Azure, this option expects an account name. See
<a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-account-overview#storage-account-endpoints" class="bare">https://docs.microsoft.com/en-us/azure/storage/common/storage-account-overview#storage-account-endpoints</a>
for more information.</p>
</div>
<div class="paragraph">
<p>When using GCP, this option expects a client id. See
<a href="https://cloud.google.com/storage/docs/authentication" class="bare">https://cloud.google.com/storage/docs/authentication</a> for more information.</p>
</div>
</dd>
<dt class="hdlist1">--obj-cacert &lt;cert_path&gt;</dt>
<dd>
<p>Specifies a CA certificate that will be used to verify the identity of the
object store being connected to.</p>
</dd>
<dt class="hdlist1">--obj-endpoint &lt;endpoint&gt;</dt>
<dd>
<p>The host/address of your object store.</p>
</dd>
<dt class="hdlist1">--obj-no-ssl-verify</dt>
<dd>
<p>Skips the SSL verification phase when connecting to the object store.
Specifying this flag will allow a connection using SSL encryption, but you
are vulnerable to a man-in-the-middle attack.</p>
</dd>
<dt class="hdlist1">--obj-region &lt;region&gt;</dt>
<dd>
<p>The region in which your bucket/container resides. For AWS this option may be
omitted when using the shared config functionality. See the AWS section of
the cloud documentation for more information.</p>
</dd>
<dt class="hdlist1">--obj-secret-access-key &lt;secret_access_key&gt;</dt>
<dd>
<p>The secret access key which has access to you chosen object store. This
option can be omitted when using the shared config functionality provided by
your chosen object store. Can alternatively be provided using the
<code>CB_OBJSTORE_SECRET_ACCESS_KEY</code> environment variable.</p>
<div class="paragraph">
<p>When using AWS, this option expects a secret access key. See
<a href="https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#access-keys-and-secret-access-keys" class="bare">https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html#access-keys-and-secret-access-keys</a>
for more information.</p>
</div>
<div class="paragraph">
<p>When using Azure, this option expects an account key. See
<a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-account-keys-manage?tabs=azure-portal" class="bare">https://docs.microsoft.com/en-us/azure/storage/common/storage-account-keys-manage?tabs=azure-portal</a>
for more information.</p>
</div>
<div class="paragraph">
<p>When using GCP, this option expects a client secret. See
<a href="https://cloud.google.com/storage/docs/authentication" class="bare">https://cloud.google.com/storage/docs/authentication</a> for more information.</p>
</div>
</dd>
<dt class="hdlist1">--obj-log-level &lt;level&gt;</dt>
<dd>
<p>Set the log level for the cloud providers SDK. By default logging will be
disabled. Valid options are cloud provider specific and are listed below.</p>
<div class="paragraph">
<p>The valid options for the AWS SDK are <code>debug</code>, <code>debug-with-signing</code>,
<code>debug-with-body</code>, <code>debug-with-request-retries</code>, <code>debug-with-request-errors</code>,
and <code>debug-with-event-stream-body</code>.</p>
</div>
<div class="paragraph">
<p>The valid options for the Azure SDK are <code>info</code>, <code>debug</code>, <code>debug-with-request-retries</code> and
<code>debug-with-request-retries-and-lro</code>.</p>
</div>
<div class="paragraph">
<p>The Google Storage SDK does not expose advanced logging configuration meaning
this option is explicitly ignored, however, this behavior may change in the
future.</p>
</div>
</dd>
<dt class="hdlist1">--obj-auth-by-instance-metadata</dt>
<dd>
<p>Depending on the cloud provider, using instance metadata for authentication
is disabled by default. Supplying this flag will allow the fetching
credentials/auth tokens from (VM) internal instance metadata endpoints.</p>
<div class="paragraph">
<p>By default, this option is disabled for AWS.</p>
</div>
<div class="paragraph">
<p>By default, this option is enabled for Azure.</p>
</div>
<div class="paragraph">
<p>By default, this option is enabled for GCP.</p>
</div>
</dd>
<dt class="hdlist1">--obj-auth-file</dt>
<dd>
<p>GCP offers the ability to use a file which contains credentials which will be
used to perform authentication. The <code>--obj-auth-file</code> flag accepts a path to
an authentication file. This flag is unsupported for the AWS/Azure cloud
providers.</p>
</dd>
<dt class="hdlist1">--obj-refresh-token</dt>
<dd>
<p>GCP requires a refresh token when using static credentials, this will be used
to refresh oauth2 tokens when accessing remote storage.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="aws-s3-options"><a class="anchor" href="#aws-s3-options"></a>AWS S3 Options</h4>
<div class="sect4">
<h5 id="optional-3"><a class="anchor" href="#optional-3"></a>Optional</h5>
<div class="dlist">
<dl>
<dt class="hdlist1">--s3-force-path-style</dt>
<dd>
<p>By default the updated virtual style paths will be used when interfacing with
AWS S3. This option will force the AWS SDK to use the alternative path style
URLs which are often required by S3 compatible object stores.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="encryption-developer-preview"><a class="anchor" href="#encryption-developer-preview"></a>Encryption (Developer Preview)</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">--passphrase &lt;passphrase&gt;</dt>
<dd>
<p>Passphrase can be used instead of an external key manager. This is not
supported on production and should only be used in development or testing.</p>
</dd>
<dt class="hdlist1">--km-key-url &lt;url&gt;</dt>
<dd>
<p>Provides the Key Identifier in the external Key Management system. Currently
supported KMSs are AWS KMS, GCP KMS, Azure KeyVault, HashiCorp Vault Transit
secrets engine. The option can also be provided using the environmental
variable <code>CB_KM_KEY_URL</code>. For more on how to authenticate using the different
providers see <a href="cbbackupmgr-encryption.html" class="xref page">cbbackupmgr-encryption</a>.</p>
<div class="paragraph">
<p>For AWS the expected key format is <code>awskms://&lt;KEY-ID|KEY-ALIAS&gt;</code>, for example
<code>awskms://alias/keyAlias</code>.</p>
</div>
<div class="paragraph">
<p>For GCP the expected key format is <code>gcpkms://&lt;KEY-RESOURCE-ID&gt;</code>, for example
<code>gcpkms://projects/project-id/locations/location/keyRings/keyring/cryptoKeys/key</code>.</p>
</div>
<div class="paragraph">
<p>For Azure key vault the expected key format is <code>azurekeyvault://&lt;KEY-IDENTIFIER&gt;</code>
for example:
<code>azurekeyvault://vault-name.vault.azure.net/object-type/object-name/object-version</code>.</p>
</div>
<div class="paragraph">
<p>For HashiCorp Vault the expected format is <code>hashivaults://&lt;HOST&gt;/&lt;KEY-NAME&gt;</code>
for example:
<code>hashivaults://127.0.0.1:8200/keyName</code>.</p>
</div>
</dd>
<dt class="hdlist1">--km-region &lt;region&gt;</dt>
<dd>
<p>Required when using AWS KMS, it allows you to set the key region.</p>
</dd>
<dt class="hdlist1">--km-endpoint &lt;endpoint&gt;</dt>
<dd>
<p>The host or address to use as your KMS. It will override the default SDK one.</p>
</dd>
<dt class="hdlist1">--km-access-key-id &lt;id&gt;</dt>
<dd>
<p>The user ID used to connect to the key management service. It can also be
provided via <code>CB_KM_ACCESS_KEY_ID</code> environmental variable. Please refer
to <a href="cbbackupmgr-encryption.html" class="xref page">cbbackupmgr-encryption</a> for the required authentication for each
provider.</p>
</dd>
<dt class="hdlist1">--km-secret-access-key &lt;key&gt;</dt>
<dd>
<p>The key used to connect to the key management service. It can also be
provided via the <code>CB_KM_SECRET_ACCESS_KEY</code> environmental variable. Please
refer to <a href="cbbackupmgr-encryption.html" class="xref page">cbbackupmgr-encryption</a> for the required authentication for
each provider.</p>
</dd>
<dt class="hdlist1">--km-tenant-id &lt;id&gt;</dt>
<dd>
<p>The tenant ID used to connect to the key management service. It can also be
provided via the <code>CB_KM_TENANT_ID</code> environmental variable. This argument is
only required when doing access key authentication with Azure. Please refer
to <a href="cbbackupmgr-encryption.html" class="xref page">cbbackupmgr-encryption</a> for the required authentication for each
provider.</p>
</dd>
<dt class="hdlist1">--km-auth-file &lt;path&gt;</dt>
<dd>
<p>The path to a file containing the authentication credentials for the key
management service. It can also be provided via the <code>CB_KM_AUTH_FILE</code>
environmental variable. Please refer to <a href="cbbackupmgr-encryption.html" class="xref page">cbbackupmgr-encryption</a> for the
required authentication for each provider.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="HOST_FORMATS"><a class="anchor" href="#HOST_FORMATS"></a>HOST FORMATS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When specifying a host/cluster for a command using the <code>-c</code>/<code>--cluster</code> flag, the following formats
are accepted:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;addr&gt;:&lt;port&gt;</code></p>
</li>
<li>
<p><code>http://&lt;addr&gt;:&lt;port&gt;</code></p>
</li>
<li>
<p><code>https://&lt;addr&gt;:&lt;port&gt;</code></p>
</li>
<li>
<p><code>couchbase://&lt;addr&gt;:&lt;port&gt;</code></p>
</li>
<li>
<p><code>couchbases://&lt;addr&gt;:&lt;port&gt;</code></p>
</li>
<li>
<p><code>couchbase://&lt;srv&gt;</code></p>
</li>
<li>
<p><code>couchbases://&lt;srv&gt;</code></p>
</li>
<li>
<p><code>&lt;addr&gt;:&lt;port&gt;,&lt;addr&gt;:&lt;port&gt;</code></p>
</li>
<li>
<p><code>&lt;scheme&gt;://&lt;addr&gt;:&lt;port&gt;,&lt;addr&gt;:&lt;port&gt;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>&lt;port&gt;</code> portion of the host format may be omitted, in which case the default port will be used
for the scheme provided. For example, <code>http://</code> and <code>couchbase://</code> will both default to 8091 where
<code>https://</code> and <code>couchbases://</code> will default to 18091. When connecting to a host/cluster using a
non-default port, the <code>&lt;port&gt;</code> portion of the host format must be specified.</p>
</div>
<div class="sect2">
<h3 id="connection-strings-multiple-nodes"><a class="anchor" href="#connection-strings-multiple-nodes"></a>Connection Strings (Multiple nodes)</h3>
<div class="paragraph">
<p>The <code>-c</code>/<code>--cluster</code> flag accepts multiple nodes in the format of a connection string; this is a
comma separated list of <code>&lt;addr&gt;:&lt;port&gt;</code> strings where <code>&lt;scheme&gt;</code> only needs to be specified once.
The main advantage of supplying multiple hosts is that in the event of a failure, the next host in
the list will be used.</p>
</div>
<div class="paragraph">
<p>For example, all of the following are valid connection strings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>localhost,[::1]</code></p>
</li>
<li>
<p><code>10.0.0.1,10.0.0.2</code></p>
</li>
<li>
<p><code>http://10.0.0.1,10.0.0.2</code></p>
</li>
<li>
<p><code>https://10.0.0.1:12345,10.0.0.2</code></p>
</li>
<li>
<p><code>couchbase://10.0.0.1,10.0.0.2</code></p>
</li>
<li>
<p><code>couchbases://10.0.0.1:12345,10.0.0.2:12345</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="srv-records"><a class="anchor" href="#srv-records"></a>SRV Records</h3>
<div class="paragraph">
<p>The <code>-c</code>/<code>--cluster</code> flag accepts DNS SRV records in place of a host/cluster address where the SRV
record will be resolved into a valid connection string. There are a couple of rules which must be
followed when supplying an SRV record which are as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>&lt;scheme&gt;</code> portion must be either <code>couchbase://</code> or <code>couchbases://</code></p>
</li>
<li>
<p>The <code>&lt;srv&gt;</code> portion should be a hostname with no port</p>
</li>
<li>
<p>The <code>&lt;srv&gt;</code> portion must not be a valid IP address</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, all of the following are valid connection string using an SRV record:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>couchbase://hostname</code></p>
</li>
<li>
<p><code>couchbases://hostname</code></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="alternate-addressing-caok8s"><a class="anchor" href="#alternate-addressing-caok8s"></a>Alternate Addressing (CAO/K8S)</h3>
<div class="paragraph">
<p>Users of the CAO (Couchbase Autonomous Operator) or K8S may need to supply the
<code>network=external</code> query parameter to force connection via the defined
alternate addressing.</p>
</div>
<div class="paragraph">
<p>For example, the following are valid connection strings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>https://10.0.0.1:12345,10.0.0.2?network=default</code></p>
</li>
<li>
<p><code>https://10.0.0.1:12345,10.0.0.2?network=external</code></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="CERTIFICATE_AUTHENTICATION"><a class="anchor" href="#CERTIFICATE_AUTHENTICATION"></a>CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This tool supports authenticating against a Couchbase Cluster by using certificate based authentication (mTLS
authentication). To use certificate based authentication a certificate/key must be supplied, there a currently
multiple ways this may be done.</p>
</div>
<div class="sect2">
<h3 id="pem-encoded-certificatekey"><a class="anchor" href="#pem-encoded-certificatekey"></a>PEM ENCODED CERTIFICATE/KEY</h3>
<div class="paragraph">
<p>An unencrypted PEM encoded certificate/key may be supplied by using:
- <code>--client-cert &lt;path&gt;</code>
- <code>--client-key &lt;path&gt;</code></p>
</div>
<div class="paragraph">
<p>The file passed to <code>--client-cert</code> must contain the client certificate, and an optional chain required to authenticate
the client certificate.</p>
</div>
<div class="paragraph">
<p>The file passed to <code>--client-key</code> must contain at most one private key, the key can be in one of the following formats:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>PKCS#1</p>
</li>
<li>
<p>PKCS#8</p>
</li>
<li>
<p>EC</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Currently, only the following key types are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RSA</p>
</li>
<li>
<p>ECDSA</p>
</li>
<li>
<p>ED25519</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="pem-encoded-certificatepem-or-der-encrypted-pkcs8-key"><a class="anchor" href="#pem-encoded-certificatepem-or-der-encrypted-pkcs8-key"></a>PEM ENCODED CERTIFICATE/PEM OR DER ENCRYPTED PKCS#8 KEY</h3>
<div class="paragraph">
<p>An encrypted PKCS#8 formatted key may be provided using:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--client-cert &lt;path&gt;</code></p>
</li>
<li>
<p><code>--client-key &lt;path&gt;</code></p>
</li>
<li>
<p><code>--client-key-password &lt;password&gt;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The file passed to <code>--client-cert</code> must contain the client certificate, and an optional chain required to authenticate
the client certificate.</p>
</div>
<div class="paragraph">
<p>Currently, only the following key types are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RSA</p>
</li>
<li>
<p>ECDSA</p>
</li>
<li>
<p>ED25519</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="encrypted-pkcs12-certificatekey"><a class="anchor" href="#encrypted-pkcs12-certificatekey"></a>ENCRYPTED PKCS#12 CERTIFICATE/KEY</h3>
<div class="paragraph">
<p>An encrypted PKCS#12 certificate/key may be provided using:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>--client-cert &lt;path&gt;</code></p>
</li>
<li>
<p><code>--client-cert-password &lt;password&gt;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The file passed to <code>--client-cert</code> must contain the client certificate and exactly one private key. It may also contain
the chain required to authenticate the client certificate.</p>
</div>
<div class="paragraph">
<p>Currently, only the following key types are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>RSA</p>
</li>
<li>
<p>ECDSA</p>
</li>
<li>
<p>ED25519</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rbac"><a class="anchor" href="#rbac"></a>RBAC</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When performing a backup/restore with a user which is using RBAC, there are a
couple of things that should be taken into consideration each of which is
highlighted in this section.</p>
</div>
<div class="sect2">
<h3 id="bucket-level"><a class="anchor" href="#bucket-level"></a>Bucket Level</h3>
<div class="paragraph">
<p>Bucket level data may be backed up/restored using the <code>data_backup</code> (Data
Backup &amp; Restore) role.</p>
</div>
<div class="paragraph">
<p>The <code>data_backup</code> role does not have access to cluster level data such as:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Analytics Synonyms</p>
</li>
<li>
<p>Eventing Metadata</p>
</li>
<li>
<p>FTS Aliases</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Backing up/restoring cluster level data with the <code>data_backup</code> role will cause
permission errors like the one below.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Error backing up cluster: {"message":"Forbidden. User needs one of the following permissions","permissions":["cluster.fts!read"]}</pre>
</div>
</div>
<div class="paragraph">
<p>When presented with an error message such as the one above, there&#8217;s two clear
options.</p>
</div>
<div class="paragraph">
<p>The first option is to provide the user with the required credentials using
either the cli, REST API or Couchbase Server WebUI. This can be done by editing
the user and adding the required role. See <code>Cluster Level</code> for more information
about the required roles.</p>
</div>
<div class="paragraph">
<p>Secondly, backing up/restoring the specific service can be disabled. For
backups this must be done when configuring the repository with the <code>config</code>
command using the <code>--disable</code> style flags. For restore, these flags may be used
directly to disable one or more services. See the backup/restore documentation
for more information.</p>
</div>
</div>
<div class="sect2">
<h3 id="cluster-level"><a class="anchor" href="#cluster-level"></a>Cluster Level</h3>
<div class="paragraph">
<p>Backing up/restoring cluster level data requires additional RBAC roles, each of
which is highlighted below:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Analytics Synonyms</dt>
<dd>
<p><code>analytics_admin</code> (Analytics Admin)</p>
</dd>
<dt class="hdlist1">Eventing Metadata</dt>
<dd>
<p><code>eventing_admin</code> (Eventing Full Admin)</p>
</dd>
<dt class="hdlist1">FTS Aliases</dt>
<dd>
<p><code>fts_admin</code> (Search Admin)</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>These additional roles are required since this is cluster level data which may
encompass multiple buckets.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="examples"><a class="anchor" href="#examples"></a>EXAMPLES</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following command is used to take a backup of a Couchbase cluster.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cbbackupmgr config --archive /data/backups --repo example
$ cbbackupmgr backup -a /data/backups -r example \
 -c couchbase://172.23.10.5 -u Administrator -p password</pre>
</div>
</div>
<div class="paragraph">
<p>Once the backup has finished there will be a new directory in the specified
backup repository containing the backed up data. You can see this new directory
using the <a href="cbbackupmgr-info.html" class="xref page">cbbackupmgr-info</a> command.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ cbbackupmgr info -a /data/backups --all

| Archive
| -------
| Name           | UUID                                 | Size     | # Repos |
| backup_archive | b4b8f2bb-5569-47d9-80c1-00821f711761 | 55.56MiB | 1       |
|
| Repos
| -----
|
| + Repo
|   ----
|   Name       | Size     | # Backups | Encrypted | Point in Time |
|   Manchester | 55.56MiB | 1         | false     | false         |
|
|   Backups
|   -------
|
|  *  Backup
|     ------
|     Name                           | Size     | Type | Complete |
|     2019-03-15T13_52_27.18301Z     | 52.42MiB | FULL | true     |
|
|     Merged Range
|     ------------
|     Start | End | Count |
|     N/A   | N/A | N/A   |
|
|     Cluster
|     -------
|     Hostname              | UUID                             |
|     http://localhost:8091 | 3adac7367a4117b3a8b12bf0e7f322be |
|
|     Services
|     --------
|
|       Eventing
|       --------
|       Functions |
|       1         |
|
|       FTS
|       ---
|       Aliases |
|       2       |
|
|       Query
|       -----
|       UDFs |
|       0    |
|
|     Buckets
|     -------
|
|   -   Bucket
|       ------
|       Name        | Size    |
|       beer-sample | 6.85MiB |
|
|       Services
|       --------
|
|         Data
|         ----
|         Mutations | Deletions | Size    |
|         7303      | 0         | 6.85MiB |
|
|           Point in Time
|           -------------
|           Mutations | Deletions | Duplicate Size |
|           7303      | 0         | 0B             |
|
|         Views
|         -----
|         Definitions |
|         1           |
|
|         Analytics
|         ---------
|         CBAS |
|         0    |
|
|         FTS
|         ---
|         Aliases |
|         0       |
|
|         Indexing
|         --------
|         Indexes |
|         1       |
|
|   -   Bucket
|       ------
|       Name           | Size    |
|       gamesim-sample | 2.86MiB |
|
|       Services
|       --------
|
|         Data
|         ----
|         Mutations | Deletions | Size    |
|         586       | 0         | 2.86MiB |
|
|           Point in Time
|           -------------
|           Mutations | Deletions | Duplicate Size |
|           586       | 0         | 0B             |
|
|         Views
|         -----
|         Definitions |
|         1           |
|
|         Analytics
|         ---------
|         CBAS |
|         0    |
|
|         FTS
|         ---
|         Aliases |
|         0       |
|
|         Indexing
|         --------
|         Indexes |
|         1       |
|
|   -   Bucket
|       ------
|       Name          | Size     |
|       travel-sample | 42.72MiB |
|
|       Services
|       --------
|
|         Data
|         ----
|         Mutations | Deletions | Size     |
|         31591     | 0         | 42.72MiB |
|
|           Point in Time
|           -------------
|           Mutations | Deletions | Duplicate Size |
|           31591     | 0         | 0B             |
|
|         Views
|         -----
|         Definitions |
|         0           |
|
|         Analytics
|         ---------
|         CBAS |
|         0    |
|
|         FTS
|         ---
|         Aliases |
|         0       |
|
|         Indexing
|         --------
|         Indexes |
|         10      |</pre>
</div>
</div>
<div class="paragraph">
<p>If a backup fails then it is considered a partial backup and the backup client
will not be able to back up any new data until the user decides whether to
resume or purge the partial backup. This decision is made by specifying either
the --resume or the --purge flag on the next invocation of the backup command.
Below is an example of how this process works if the user wants to resume a
backup.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cbbackupmgr config -a /data/backups -r example

$ cbbackupmgr backup -a /data/backups -r example \
 -c 172.23.10.5 -u Administrator -p password

Error backing up cluster: Not all data was backed up due to connectivity
issues. Check to make sure there were no server side failures during
backup. See backup logs for more details on what wasn't backed up.

$ cbbackupmgr backup -a /data/backups -r example \
 -c 172.23.10.5 -u Administrator -p password

Error backing up cluster: Partial backup error 2016-02-11T17:00:19.594970735-08:00

$ cbbackupmgr backup -a /data/backups -r example -c 172.23.10.5 \
 -u Administrator -p password --resume

Backup successfully completed</pre>
</div>
</div>
<div class="paragraph">
<p>To backup a cluster with a different amount of concurrent clients and decrease
the backup time you can specify the --threads flag. Remember that specifying a
higher number of concurrent clients increases the amount of resources the
cluster uses to complete the backup. Below is an example of using 16 concurrent
clients.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cbbackupmgr config -a /data/backups -r example

$ cbbackupmgr backup -a /data/backups -r example \
 -c 172.23.10.5 -u Administrator -p password -t 16</pre>
</div>
</div>
<div class="paragraph">
<p>To force the creation of a full backup, use the <code>--full-backup</code> flag. This will
result in cbbackupmgr streaming all the available data again. It&#8217;s expected
that more disk space will be used and that the full backup will take longer
than performing an incremental backup (the default).</p>
</div>
<div class="paragraph">
<p>In the example below, the first backup is implicitly a full backup, the second
backup is an incremental (where no additional data needed to be backed up) and
the third is a forced full backup (note that we backed up the same amount of
items as the first backup).</p>
</div>
<div class="literalblock">
<div class="content">
<pre>$ cbbackupmgr backup -a ~/Projects/couchbase-archive -r repo -c 172.20.1.1 -u Administrator -p asdasd
Backing up to '2021-02-09T13_35_15.426546996Z'
Copied all data in 2.865028528s (Avg. 10.53MB/Sec)                                                                                        31591 items / 21.06MB
[=====================================================================================================================================================] 100.00%
Backup completed successfully
Backed up bucket "travel-sample" succeeded
Mutations backed up: 31591, Mutations failed to backup: 0
Deletions backed up: 0, Deletions failed to backup: 0

$ cbbackupmgr backup -a ~/Projects/couchbase-archive -r repo -c 172.20.1.1 -u Administrator -p asdasd
Backing up to '2021-02-09T13_35_21.580950579Z'
Copied all data in 504.852625ms (Avg. 56.00KB/Sec)                                                                                            0 items / 56.00KB
[=====================================================================================================================================================] 100.00%
Backup completed successfully
Backed up bucket "travel-sample" succeeded
Mutations backed up: 0, Mutations failed to backup: 0
Deletions backed up: 0, Deletions failed to backup: 0
Skipped due to purge number or conflict resolution: Mutations: 0 Deletions: 0

$ cbbackupmgr backup -a ~/Projects/couchbase-archive -r repo -c 172.20.1.1 -u Administrator -p asdasd --fullbackup
Backing up to '2021-02-09T13_35_24.18890408Z'
Copied all data in 2.85286061s (Avg. 10.53MB/Sec)                                                                                         31591 items / 21.06MB
[=====================================================================================================================================================] 100.00%
Backup completed successfully
Backed up bucket "travel-sample" succeeded
Mutations backed up: 31591, Mutations failed to backup: 0
Deletions backed up: 0, Deletions failed to backup: 0
Skipped due to purge number or conflict resolution: Mutations: 0 Deletions: 0</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="collection-aware-backups"><a class="anchor" href="#collection-aware-backups"></a>COLLECTION AWARE BACKUPS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The 7.0.0 release of Couchbase Server introduced collections supports. The
following section will briefly discuss how this affects backups created by
cbbackupmgr.</p>
</div>
<div class="sect2">
<h3 id="what-makes-a-backup-collection-aware"><a class="anchor" href="#what-makes-a-backup-collection-aware"></a>What makes a backup collection aware?</h3>
<div class="paragraph">
<p>cbbackupmgr is not limited to only backing up the cluster version it was
released with; it may be used to backup previous versions of Couchbase
Server. This means that cbbackupmgr is able to create backups which are
collection aware or unaware.</p>
</div>
<div class="paragraph">
<p>The distinction between collection aware/unaware is simple; if you backup
a cluster prior to 7.0.0 your backup will be collection unaware. If you
backup a cluster version which supports collections (starting at 7.0.0)
your backup will be collection aware.</p>
</div>
<div class="paragraph">
<p>The default behavior of backup for the cluster versions which support
collections is to back up all available scopes/collections in a bucket.</p>
</div>
</div>
<div class="sect2">
<h3 id="what-if-i-dont-want-to-use-collections"><a class="anchor" href="#what-if-i-dont-want-to-use-collections"></a>What if I don&#8217;t want to use collections?</h3>
<div class="paragraph">
<p>This is perfectly valid use case and is supported by Couchbase Server and
cbbackupmgr. When interacting with backups created of a collection aware
cluster, cbbackupmgr will only output collection aware information if the
backup contains a non-default collection manifest (which implies the use of
collections).</p>
</div>
<div class="paragraph">
<p>This means you may continue using cbbackupmgr without needing to interact with
collections. Note that you may still need to update/change the flags being
passed to some sub-commands. For example, when examining a backup, you will
still need to use the <code>--collection-string</code> flag. For example instead of
<code>--bucket default</code> you should supply <code>--collection-string default</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="DISCUSSION"><a class="anchor" href="#DISCUSSION"></a>DISCUSSION</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This command always backs up data incrementally. By using the vbucket sequence
number that is associated with each item, the backup command is able to examine
previous backups in order to determine where the last backup finished.</p>
</div>
<div class="paragraph">
<p>When backing up a cluster, data for each bucket is backed up in the following
order:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Bucket Settings</code></p>
</li>
<li>
<p><code>View Definitions</code></p>
</li>
<li>
<p><code>Global Secondary Index (GSI) Definitions</code></p>
</li>
<li>
<p><code>Full-Text Index Definitions</code></p>
</li>
<li>
<p><code>Key-Value Data</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The backup command will store everything that is persisted to disk on the
Couchbase Server nodes at the time the backup is started. Couchbase server is
consistent at a vBucket level and not across a whole bucket. The tool tries
to provide a strong consistency window by opening all connection to every
node at the same time. Being a distributed system there are times when this is
not possible such as when the cluster is under-resourced or there are network
issues. These may affect the consistency of the backup across
the vBuckets. <code>cbbackupmgr backup</code> provides an Enterprise Edition, developer
preview feature that checks that the backup is inside a consistency window
(see <code>--consistency-check</code>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rollback"><a class="anchor" href="#rollback"></a>ROLLBACK</h2>
<div class="sectionbody">
<div class="paragraph">
<p>During a backup, it&#8217;s possible for cbbackupmgr to receive a rollback from the
cluster; this will be returned to you (the user) in the form of a message
similar to <code>client received rollback, either purge this backup or create a new
backup repository</code>.</p>
</div>
<div class="paragraph">
<p>There are two sensible actions which can be taken at this point (which are
briefly alluded in the above message):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>You can rerun the backup using the <code>--purge</code> flag, this will remove the
failed backup creating a new incremental backup if possible, otherwise
falling back to creating a full backup.</p>
</li>
<li>
<p>You could create a new backup repository and begin creating backups there,
this method has the advantage of preserving any possible data which was
backed up prior to receiving the rollback.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In most cases, option one will be sufficient, however, if may be the case that
the partial backup taken by cbbackupmgr contains data which you don&#8217;t want to
delete. In this case, option two allows you to retain this data which could be
restored using the <code>--restore-partial-backups</code> flag.</p>
</div>
<div class="paragraph">
<p>Note that the <code>--restore-partial-backups</code> flag is only supported for local
backups; backups stored in object store which failed due to a rollback must be
purged using the <code>--purge</code> flag.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="environment-and-configuration-variables"><a class="anchor" href="#environment-and-configuration-variables"></a>ENVIRONMENT AND CONFIGURATION VARIABLES</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">CB_CLUSTER</dt>
<dd>
<p>Specifies the hostname of the Couchbase cluster to connect to. If the
hostname is supplied as a command line argument then this value is
overridden.</p>
</dd>
<dt class="hdlist1">CB_USERNAME</dt>
<dd>
<p>Specifies the username for authentication to a Couchbase cluster. If the
username is supplied as a command line argument then this value is
overridden.</p>
</dd>
<dt class="hdlist1">CB_PASSWORD</dt>
<dd>
<p>Specifies the password for authentication to a Couchbase cluster. If the
password is supplied as a command line argument then this value is
overridden.</p>
</dd>
<dt class="hdlist1">CB_CLIENT_CERT</dt>
<dd>
<p>The path to a client certificate used to authenticate when connecting to a
cluster. May be supplied with <code>CB_CLIENT_KEY</code> as an alternative to the
<code>CB_USERNAME</code> and <code>CB_PASSWORD</code> variables. See the <a href="#CERTIFICATE_AUTHENTICATION">CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</a>
section for more information.</p>
</dd>
<dt class="hdlist1">CB_CLIENT_CERT_PASSWORD</dt>
<dd>
<p>The password for the certificate provided to the <code>CB_CLIENT_CERT</code> variable,
when using this variable, the certificate/key pair is expected to be in the
PKCS#12 format. See the <a href="#CERTIFICATE_AUTHENTICATION">CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</a> section for more
information.</p>
</dd>
<dt class="hdlist1">CB_CLIENT_KEY</dt>
<dd>
<p>The path to the client private key whose public key is contained in the
certificate provided to the <code>CB_CLIENT_CERT</code> variable. May be supplied with
<code>CB_CLIENT_CERT</code> as an alternative to the <code>CB_USERNAME</code> and <code>CB_PASSWORD</code>
variables. See the <a href="#CERTIFICATE_AUTHENTICATION">CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</a> section for more information.</p>
</dd>
<dt class="hdlist1">CB_CLIENT_KEY_PASSWORD</dt>
<dd>
<p>The password for the key provided to the <code>CB_CLIENT_KEY</code> variable, when using
this variable, the key is expected to be in the PKCS#8 format.  See the
<a href="#CERTIFICATE_AUTHENTICATION">CERTIFICATE AUTHENTICATION (MTLS AUTHENTICATION)</a> section for more information.</p>
</dd>
<dt class="hdlist1">CB_ARCHIVE_PATH</dt>
<dd>
<p>Specifies the path to the backup archive. If the archive path is supplied as
a command line argument then this value is overridden.</p>
</dd>
<dt class="hdlist1">CB_OBJSTORE_STAGING_DIRECTORY</dt>
<dd>
<p>Specifies the path to the staging directory. If the <code>--obj-staging-dir</code>
argument is provided in the command line then this value is overridden.</p>
</dd>
<dt class="hdlist1">CB_OBJSTORE_REGION</dt>
<dd>
<p>Specifies the object store region. If the <code>--obj-region</code> argument is provided
in the command line then this value is overridden.</p>
</dd>
<dt class="hdlist1">CB_OBJSTORE_ACCESS_KEY_ID</dt>
<dd>
<p>Specifies the object store access key id. If the <code>--obj-access-key-id</code>
argument is provided in the command line this value is overridden.</p>
</dd>
<dt class="hdlist1">CB_OBJSTORE_SECRET_ACCESS_KEY</dt>
<dd>
<p>Specifies the object store secret access key. If the
<code>--obj-secret-access-key</code> argument is provided in the command line this value
is overridden.</p>
</dd>
<dt class="hdlist1">CB_OBJSTORE_REFRESH_TOKEN</dt>
<dd>
<p>Specifies the refresh token to use. If the <code>--obj-refresh-token</code> argument is
provided in the command line, this value is overridden.</p>
</dd>
<dt class="hdlist1">CB_AWS_ENABLE_EC2_METADATA</dt>
<dd>
<p>By default cbbackupmgr will disable fetching EC2 instance metadata. Setting
this environment variable to true will allow the AWS SDK to fetch metadata
from the EC2 instance endpoint.</p>
</dd>
<dt class="hdlist1">CB_ENCRYPTION_PASSPHRASE</dt>
<dd>
<p>Specifies the passphrase used for encryption.</p>
</dd>
<dt class="hdlist1">CB_KM_KEY_URL</dt>
<dd>
<p>Specifies the URL identifying the encryption key on the KMS. See
<code>--km-key-url</code> for the expected format and accepted KMSs.</p>
</dd>
<dt class="hdlist1">CB_KM_ACCESS_ID</dt>
<dd>
<p>Specifies the key/user ID used to connect to the KMS.</p>
</dd>
<dt class="hdlist1">CB_KM_SECRET_ACCESS_KEY</dt>
<dd>
<p>Specifies the secret key/token used to connect to the KMS.</p>
</dd>
<dt class="hdlist1">CB_KM_AUTH_FILE</dt>
<dd>
<p>Specifies a path to a file containing the required credentials to connect to
the KMS.</p>
</dd>
<dt class="hdlist1">CB_KM_TENANT_ID</dt>
<dd>
<p>Specifies the cloud provider tenant to connect to the KMS with. This value is
only for when using access key authentication in Azure.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="files"><a class="anchor" href="#files"></a>FILES</h2>
<div class="sectionbody">
<div class="dlist">
<dl>
<dt class="hdlist1">restrictions.json</dt>
<dd>
<p>Keeps a list of restrictions used to ensure data is not restored to a
cluster with an incompatible version or a bucket with an incompatible
conflict resolution type.</p>
</dd>
<dt class="hdlist1">bucket-config.json</dt>
<dd>
<p>Stores the bucket configuration settings for a bucket.</p>
</dd>
<dt class="hdlist1">views.json</dt>
<dd>
<p>Stores the view definitions for a bucket.</p>
</dd>
<dt class="hdlist1">gsi.json</dt>
<dd>
<p>Stores the global secondary index (GSI) definitions for a bucket.</p>
</dd>
<dt class="hdlist1">full-text.json</dt>
<dd>
<p>Stores the full-text index definitions for a bucket.</p>
</dd>
<dt class="hdlist1">users.json</dt>
<dd>
<p>The config command creates a users configuration file in the backup
repository called users.json. This file contains the users configuration for
all the users in the cluster including their roles, permissions and groups
they are a part of. It should never be modified and treated as a read-only
file.</p>
</dd>
<dt class="hdlist1">index_*.sqlite.0</dt>
<dd>
<p>Stores an index of document keys in the given vBucket.</p>
</dd>
<dt class="hdlist1">data_*.rift.0</dt>
<dd>
<p>Stores the document values in the given vBucket.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="see-also"><a class="anchor" href="#see-also"></a>SEE ALSO</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="cbbackupmgr-config.html" class="xref page">cbbackupmgr-config</a>,
<a href="cbbackupmgr-info.html" class="xref page">cbbackupmgr-info</a>,
<a href="cbbackupmgr-strategies.html" class="xref page">cbbackupmgr-strategies</a>,
<a href="cbbackupmgr-cloud.html" class="xref page">cbbackupmgr-cloud</a>,
<a href="cbbackupmgr-encryption.html" class="xref page">cbbackupmgr-encryption</a>,
<a href="cbbackupmgr-network-filesystems.html" class="xref page">cbbackupmgr-network-filesystems</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cbbackupmgr"><a class="anchor" href="#cbbackupmgr"></a>CBBACKUPMGR</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Part of the <a href="cbbackupmgr.html" class="xref page">cbbackupmgr</a> suite</p>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <div class="container">
    <div class="footer-links">
      <div class="col">
        <div class="footer-logo">
          <a href="https://www.couchbase.com" class="icon">
            <img src="../../../_/img/couchbase-logo.svg" alt="Couchbase">
          </a>
        </div>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://docs.couchbase.com" target="_blank" rel="noopener">Documentation</a></li>
          <li><a href="https://forums.couchbase.com" target="_blank" rel="noopener">Forums</a></li>
          <li><a href="https://support.couchbase.com" target="_blank" rel="noopener">Support</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://developer.couchbase.com" target="_blank" rel="noopener">Developer Portal</a></li>
          <li><a href="https://blog.couchbase.com" target="_blank" rel="noopener">Blog</a></li>
          <li><a href="https://www.couchbase.com/resources">Resources</a></li>
        </ul>
      </div>
      <div class="col">
        <ul>
          <li><a href="https://www.couchbase.com/get-started-developing-nosql">Get Started</a></li>
          <li><a href="https://www.couchbase.com/downloads">Downloads</a></li>
          <li><a href="https://learn.couchbase.com/store?utf8=%E2%9C%93&ss=1&ct=78327&commit=Filter" target="_blank" rel="noopener">Training</a></li>
        </ul>
      </div>
      <div class="col">
        <ul class="social-icons">
          <li>
            <svg  width="14" height="14" viewBox="0 0 32.1 26.1"> <path id="twitter" class="cls-1" d="M32,7.1a11.836,11.836,0,0,1-3.8,1,6.462,6.462,0,0,0,2.9-3.6,12.606,12.606,0,0,1-4.2,1.6A6.492,6.492,0,0,0,22.1,4a6.594,6.594,0,0,0-6.6,6.6,7.719,7.719,0,0,0,.2,1.5A18.458,18.458,0,0,1,2.2,5.2a6.294,6.294,0,0,0-.9,3.3A6.765,6.765,0,0,0,4.2,14a6.109,6.109,0,0,1-3-.8v.1a6.543,6.543,0,0,0,5.3,6.4,4.678,4.678,0,0,1-1.7.2,4.869,4.869,0,0,1-1.2-.1,6.679,6.679,0,0,0,6.1,4.6,12.917,12.917,0,0,1-8.2,2.8,9.151,9.151,0,0,1-1.6-.1,18.438,18.438,0,0,0,10.1,3c12.1,0,18.7-10,18.7-18.7v-.8A13.336,13.336,0,0,0,32,7.2Z" transform="translate(0.1 -4)"/></svg>
            <a href="https://twitter.com/couchbase" class="icon">
              Twitter
            </a>
          </li>
          <li>
          <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="linkedin" class="cls-1" d="M29,0H3A3.076,3.076,0,0,0,0,3V29a3.009,3.009,0,0,0,3,3H29a2.946,2.946,0,0,0,3-3V3A3.009,3.009,0,0,0,29,0ZM12,26H8V12h4ZM10,10a2,2,0,1,1,2-2A2.006,2.006,0,0,1,10,10ZM26,26H22V18a2,2,0,0,0-4,0v8H14V12h4v2.5c.8-1.1,2.1-2.5,3.5-2.5A4.736,4.736,0,0,1,26,17Z"/></svg>
              <a href="https://www.linkedin.com/company/couchbase" class="icon">
             Linkedin
            </a>
          </li>
          <li>
            <svg  width="14" height="14" viewBox="0 0 32 32"> <path id="facebook" class="cls-1" d="M29,0H3A2.652,2.652,0,0,0,0,3V29a2.652,2.652,0,0,0,3,3H16V18H12V14h4V12a6.452,6.452,0,0,1,6-6h4v4H22a2.151,2.151,0,0,0-2,2v2h6l-1,4H20V32h9a2.652,2.652,0,0,0,3-3V3A2.652,2.652,0,0,0,29,0Z"/></svg>
            <a href="https://www.facebook.com/Couchbase" class="icon">
            Facebook
            </a>
          </li>
        </ul>
      </div>
    </div>
    <div class="footer-terms">
      <div class="footer-terms-copyright">
          <span> 2024 Couchbase, Inc. Couchbase, Couchbase Lite and the Couchbase logo are registered trademarks of Couchbase, Inc.</span>
      </div>
      <div class="footer-terms-links">
        <a href="https://www.couchbase.com/terms-of-use">Terms of Use</a>
        <a href="https://www.couchbase.com/privacy-policy">Privacy Policy</a>
        <a href="https://www.couchbase.com/cookie-policy">Cookie Policy</a>
        <a href="https://www.couchbase.com/support-policy">Support Policy</a>
        <a href="https://info.couchbase.com/unsubscribe-or-manage-preferences.html" target="_blank" rel="noopener">Marketing Preference Center</a>
      </div>
    </div>
  </div>
</footer>
<script src="../../../_/js/site-navigation-data.js"></script>
<script id="page-navigation-group" type="application/json">
{"title":"Server","components":["server"],"url":"/home/server.html","latestVersions":{"server":"7.6"}}
</script>
<template id="run-code-panel">
<div class="action-panel">
  <form class="action-panel-control" method="POST" action="https://couchbase.live/run" target="run-code-output">
    <input type="hidden" name="lang">
    <input type="hidden" name="code">
    <input type="hidden" name="from" value="docs">
    <div class="controls">
      <button class="control-button rerun" type="submit"><i class="fas fa-redo"></i></button>
      <span class="shell-name control-label">Output</span>
      <button class="control-button close"><i class="fas fa-times"></i> Close</button>
    </div>
  </form>
  <iframe class="run-code-output" name="run-code-output"></iframe>
</div>
</template>
<script id="site-script" src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab"></script>
<script defer src="../../../_/js/vendor/fontawesome-icon-defs.js"></script>
<script defer src="../../../_/js/vendor/fontawesome.js" data-search-pseudo-elements="true"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
</body>
</html>
